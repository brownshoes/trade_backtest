<head>
    <meta charset="UTF-8">
    <title>Flask SPA Tabs</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <!-- Remove Chart.js if you're not using it elsewhere -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- âœ… Use CDN version of Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
</head>


<div style="margin-bottom: 10px;">
    <label for="symbolSelect">Symbol: </label>
    <select id="symbolSelect">
        <option value="AAPL">AAPL</option>
        <option value="GOOGL">GOOGL</option>
        <option value="MSFT">MSFT</option>
    </select>
    <button id="loadChartBtn">Load Chart</button>
</div>

<div id="tradingview_chart" style="height: 600px; width: 100%;"></div>

<script type="text/javascript">
    let chart = null;
    let candlestickSeries = null;

    function initTradingViewChart() {
        // Check if library is loaded
        if (typeof LightweightCharts === 'undefined') {
            console.error('LightweightCharts library not loaded!');
            alert('Chart library not loaded. Please refresh the page.');
            return;
        }

        const container = document.getElementById('tradingview_chart');
        if (!container) {
            console.error('Chart container not found!');
            return;
        }

        // Create chart
        chart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 600,
            layout: {
                background: { color: '#ffffff' },
                textColor: '#333',
            },
            grid: {
                vertLines: { color: '#e1e1e1' },
                horzLines: { color: '#e1e1e1' },
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
            },
        });

        // Create candlestick series
        candlestickSeries = chart.addCandlestickSeries({
            upColor: '#26a69a',
            downColor: '#ef5350',
            borderVisible: false,
            wickUpColor: '#26a69a',
            wickDownColor: '#ef5350',
        });

        // Make chart responsive
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({
                    width: container.clientWidth
                });
            }
        });

        // Load initial data with dummy data
        loadChartData('AAPL');
    }

    function getDummyData(symbol) {
        // Generate 50 days of dummy candle data
        const dummyData = [];
        const basePrice = symbol === 'AAPL' ? 150 : symbol === 'GOOGL' ? 140 : 350;
        const startDate = new Date('2024-01-01');
        
        for (let i = 0; i < 50; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            
            // Skip weekends
            if (date.getDay() === 0 || date.getDay() === 6) continue;
            
            // Generate random candle data
            const open = basePrice + (Math.random() - 0.5) * 10;
            const close = open + (Math.random() - 0.5) * 5;
            const high = Math.max(open, close) + Math.random() * 3;
            const low = Math.min(open, close) - Math.random() * 3;
            
            dummyData.push({
                time: date.toISOString().split('T')[0], // Format: YYYY-MM-DD
                open: parseFloat(open.toFixed(2)),
                high: parseFloat(high.toFixed(2)),
                low: parseFloat(low.toFixed(2)),
                close: parseFloat(close.toFixed(2))
            });
        }
        
        return dummyData;
    }

    function loadChartData(symbol) {
        try {
            if (!candlestickSeries) {
                console.error('Chart not initialized!');
                return;
            }

            // Show loading indicator
            const container = document.getElementById('tradingview_chart');
            container.style.opacity = '0.5';

            const data = getDummyData(symbol);

            // Update chart with new data
            candlestickSeries.setData(data);

            // Fit content to view
            chart.timeScale().fitContent();

            // Remove loading indicator
            container.style.opacity = '1';

        } catch (error) {
            console.error('Error loading chart data:', error);
            alert('Failed to load chart data: ' + error.message);
            document.getElementById('tradingview_chart').style.opacity = '1';
        }
    }

    // Event listener for load button
    const loadBtn = document.getElementById('loadChartBtn');
    if (loadBtn) {
        loadBtn.addEventListener('click', () => {
            const symbol = document.getElementById('symbolSelect').value;
            loadChartData(symbol);
        });
    }
</script>