<!DOCTYPE html>
<html>
<head>
    <title>Config Editor</title>
</head>
<body>
    <h1>Config Editor</h1>
    <form method="POST">
        <h2>Load JSON Config</h2>
        <input type="file" id="json-upload" accept=".json">
        <button type="button" onclick="loadJSONConfig()">Load Config</button>

        <label>Name:</label>
        <input type="text" name="name" value="{{ config['name'] }}"><br>

        <label>Mode:</label>
        <input type="text" name="mode" value="{{ config['mode'] }}"><br>

        <label>Trade:</label>
        <input type="checkbox" name="trade" {% if config['trade'] %}checked{% endif %}><br>

        <label>Start Time:</label>
        <input type="text" name="start_time" value="{{ config['start_time'] }}"><br>

        <label>End Time:</label>
        <input type="text" name="end_time" value="{{ config['end_time'] }}"><br>

        <label>USD Holdings:</label>
        <input type="number" step="0.01" name="USD_holdings" value="{{ config['USD_holdings'] }}"><br>

        <label>Coin Holdings:</label>
        <input type="number" step="0.01" name="coin_holdings" value="{{ config['coin_holdings'] }}"><br>

        <label>Maker Fee:</label>
        <input type="number" step="0.0001" name="maker_fee" value="{{ config['maker_fee'] }}"><br>

        <label>Taker Fee:</label>
        <input type="number" step="0.0001" name="taker_fee" value="{{ config['taker_fee'] }}"><br>

        <label>Main Time Series:</label>
        <input type="text" name="main_time_series" value="{{ config['main_time_series'] }}"><br>

        <label>Time Series:</label><br>
        <div id="time-series-container"></div>
        <button type="button" onclick="addArrayField('time-series', 'time-series-container')">+ Add Time Series</button>
        <br>

        <label>Exit Time Series:</label><br>
        <div id="exit-time-series-container"></div>
        <button type="button" onclick="addArrayField('exit-time-series', 'exit-time-series-container')">+ Add Exit Time Series</button>
        <br>

        <label>CSV Input File:</label>
        <input type="text" name="csv_input_file" value="{{ config['csv_input_file'] }}"><br>

        <hr>

        <h2>Indicators</h2>
        <div id="indicators-container">
            {% for ind in config.indicators %}
                <!-- Existing indicators will be rendered via JS or server-side data -->
            {% endfor %}
        </div>
        <button type="button" onclick="addIndicator()">+ Add Indicator</button>
        <input type="hidden" id="num-indicators" name="num_indicators"  value="{{ config.indicators | length }}">

        <hr>

        <h2>Identify Entries</h2>
        <div id="identify-entry-container"></div>
        <button type="button" onclick="addIdentifyEntry()">+ Add Identify Entry</button>
        <input type="hidden" id="num-identify-entries" name="num_identify_entries" value="0">

        <h2>Identify Exits</h2>
        <div id="identify-exit-container"></div>
        <button type="button" onclick="addIdentifyExit()">+ Add Identify Exit</button>
        <input type="hidden" id="num-identify-exits" name="num_identify_exits" value="0">

        <h2>Entry Trade Conditions</h2>
        <div id="entry-trade-conditions-container">
            {% for condition in config.entry_trade_conditions %}
                <!-- Render existing blocks via JS or initially with server data -->
            {% endfor %}
        </div>
        <button type="button" onclick="addEntryTradeCondition()">+ Add Entry Trade Condition</button>
        <input type="hidden" id="num-entry-trade-conditions" name="num_entry_trade_conditions" value="{{ config.entry_trade_conditions | length }}">


        <h2>Exit Trade Conditions</h2>
        <div id="exit-trade-conditions-container">
            {% for condition in config.exit_trade_conditions %}
                <!-- Render existing blocks via JS or initially with server data -->
            {% endfor %}
        </div>
        <button type="button" onclick="addExitTradeCondition()">+ Add Exit Trade Condition</button>
        <input type="hidden" id="num-exit-trade-conditions" name="num_exit_trade_conditions" value="{{ config.exit_trade_conditions | length }}">


        <h2>Buy Strategy</h2>
        <div id="buy-strategy-container"></div>
        <input type="hidden" name="has_buy_strategy" value="1">
        <button type="button" onclick="addBuyStrategy()">+ Select Buy Strategy</button>


        <h2>Sell Strategy</h2>
        <div id="sell-strategy-container"></div>
        <input type="hidden" name="has_sell_strategy" value="1">
        <button type="button" onclick="addSellStrategy()">+ Select Sell Strategy</button>


        <h2>Exit Strategy</h2>
        <div id="exit-strategy-container"></div>
        <input type="hidden" name="has_exit_strategy" value="1">
        <button type="button" onclick="addExitStrategy()">+ Select Exit Strategy</button>


        <br><br>

        <button type="submit">Save Config</button>
    </form>

    <script>
        function createConfigBlock(configType, typeMap, index, prefix, showRemove = false) {
            const container = document.createElement('div');
            container.className = `${configType}-block`;
            container.dataset.index = index;

            const select = document.createElement('select');
            select.name = `${prefix}_type_${index}`;
            select.className = `${configType}-select`;
            select.dataset.index = index;

            Object.keys(typeMap).forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.text = type;
                select.appendChild(option);
            });

            container.appendChild(document.createTextNode("Type: "));
            container.appendChild(select);

            const argsDiv = document.createElement('div');
            argsDiv.id = `${prefix}_args_${index}`;
            argsDiv.className = `${configType}-args`;
            container.appendChild(argsDiv);

            // Add event listener
            select.addEventListener('change', () => {
                updateArgsFields(typeMap, prefix, index);
            });

            // Add remove button if requested
            if (showRemove) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'Remove';
                removeBtn.className = 'remove-button';
                removeBtn.style.marginLeft = '10px';

                removeBtn.addEventListener('click', () => {
                    container.remove();
                });

                container.appendChild(removeBtn);
            }

            return container;
        }


        function updateArgsFields(typeMap, prefix, index) {
            const select = document.querySelector(`select[name='${prefix}_type_${index}']`);
            const selectedType = select.value;
            const argsDiv = document.getElementById(`${prefix}_args_${index}`);
            argsDiv.innerHTML = '';

            const paramNames = typeMap[selectedType] || [];
            paramNames.forEach(param => {
                const input = document.createElement('input');
                input.type = 'text';
                input.name = `${prefix}_arg_${index}_${param}`;
                input.placeholder = param;
                argsDiv.appendChild(input);
            });
        }

        /**
         * Generic helper to add a text input for an array field (like time_series, exit_time_series, etc.)
         * @param {string} prefix - base name for the input (e.g., "time-series" or "exit-time-series")
         * @param {string} containerId - ID of the HTML container where inputs are added
         * @param {string} [value=""] - optional initial value
         */
        function addArrayField(prefix, containerId, value = "") {
            const container = document.getElementById(containerId);
            const index = container.querySelectorAll(`input[name^="${prefix}-"]`).length;

            const input = document.createElement('input');
            input.type = 'text';
            input.name = `${prefix}-${index}`;
            input.value = value;
            input.classList.add('array-input');

            container.appendChild(input);
            container.appendChild(document.createElement('br'));
        }

        /**
         * Populates a container with array fields from JSON data
         * @param {string} prefix - same base name (e.g., "time-series")
         * @param {string} containerId - container element ID
         * @param {Array} values - array of strings to populate
         */
        function populateArrayFields(prefix, containerId, values = []) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // clear existing fields

            values.forEach(value => addArrayField(prefix, containerId, value));
        }


        let indicatorCount = {{ config.indicators | length }};
        const indicatorClasses = {{ indicator_classes | tojson }};

        let entryTradeConditionCount = {{ config.entry_trade_conditions | length }};
        const entryConditionTypes = {{ entry_condition_classes | tojson }};

        let exitTradeConditionCount = {{ config.exit_trade_conditions | length }};
        const exitConditionTypes = {{ exit_condition_classes | tojson }};

        const buyStrategyTypes = {{ buy_strategy_classes | tojson }};
        const sellStrategyTypes = {{ sell_strategy_classes | tojson }};
        const exitStrategyTypes = {{ exit_strategy_classes | tojson }};

        function addIndicator() {
            const container = document.getElementById('indicators-container');
            const block = createConfigBlock('indicator', indicatorClasses, indicatorCount, 'indicator', true, true);
            container.appendChild(block);
            updateArgsFields(indicatorClasses, 'indicator', indicatorCount);
            indicatorCount++;
            document.getElementById('num-indicators').value = indicatorCount;
        }

        function addEntryTradeCondition() {
            const container = document.getElementById('entry-trade-conditions-container');
            const block = createConfigBlock('entry-trade-condition', entryConditionTypes, entryTradeConditionCount, 'entry-trade-condition', true);
            container.appendChild(block);
            updateArgsFields(entryConditionTypes, 'entry-trade-condition', entryTradeConditionCount);
            document.getElementById('num-entry-trade-conditions').value = ++entryTradeConditionCount;
        }

        function addExitTradeCondition() {
            const container = document.getElementById('exit-trade-conditions-container');
            const block = createConfigBlock('exit-trade-condition', exitConditionTypes, exitTradeConditionCount, 'exit-trade-condition', true);
            container.appendChild(block);
            updateArgsFields(exitConditionTypes, 'exit-trade-condition', exitTradeConditionCount);
            document.getElementById('num-exit-trade-conditions').value = ++exitTradeConditionCount;
        }

        // These are always single-object blocks, so index is always 0
        function addBuyStrategy() {
            const container = document.getElementById('buy-strategy-container');
            container.innerHTML = ''; // Ensure only one exists
            const block = createConfigBlock('buy-strategy', buyStrategyTypes, 0, 'buy-strategy', true);
            container.appendChild(block);
            updateArgsFields(buyStrategyTypes, 'buy-strategy', 0);
        }

        function addSellStrategy() {
            const container = document.getElementById('sell-strategy-container');
            container.innerHTML = '';
            const block = createConfigBlock('sell-strategy', sellStrategyTypes, 0, 'sell-strategy', true);
            container.appendChild(block);
            updateArgsFields(sellStrategyTypes, 'sell-strategy', 0);
        }

        function addExitStrategy() {
            const container = document.getElementById('exit-strategy-container');
            container.innerHTML = '';
            const block = createConfigBlock('exit-strategy', exitStrategyTypes, 0, 'exit-strategy', true);
            container.appendChild(block);
            updateArgsFields(exitStrategyTypes, 'exit-strategy', 0);
        }


        const identifyEntryClasses = {{ identify_entry_classes | tojson }};
        const identifyExitClasses = {{ identify_exit_classes | tojson }};

        let identifyEntryCount = 0;
        let identifyExitCount = 0;

        // General function to add identify entry/exit blocks
        function addConfigBlockWithIndicatorRef(typeKey, typeMap, countVar) {
            const container = document.getElementById(`${typeKey}-container`);
            const block = createConfigBlock(typeKey, typeMap, window[countVar], typeKey, true);

            // Create Indicator Ref Index dropdown
            const indicatorSelect = document.createElement('select');
            indicatorSelect.name = `${typeKey}_indicator_ref_${window[countVar]}`;

            const indicatorBlocks = document.querySelectorAll('.indicator-block');
            indicatorBlocks.forEach((block, idx) => {
                const select = block.querySelector('select');
                const type = select ? select.value : `Indicator ${idx}`;
                const option = document.createElement('option');
                option.value = idx;
                option.text = `${type} (index ${idx})`;
                indicatorSelect.appendChild(option);
            });

            const label = document.createElement('label');
            label.textContent = 'Indicator Ref Index: ';
            block.appendChild(document.createElement('br'));
            block.appendChild(label);
            block.appendChild(indicatorSelect);

            container.appendChild(block);

            window[countVar]++;
            document.getElementById(`num-${typeKey}s`).value = window[countVar];
        }

        // Entry-specific wrapper
        function addIdentifyEntry() {
            addConfigBlockWithIndicatorRef('identify-entry', identifyEntryClasses, 'identifyEntryCount');
        }

        // Exit-specific wrapper
        function addIdentifyExit() {
            addConfigBlockWithIndicatorRef('identify-exit', identifyExitClasses, 'identifyExitCount');
        }

    </script>

    <script>
        function loadJSONConfig() {
            const fileInput = document.getElementById('json-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select a JSON file.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const config = JSON.parse(e.target.result);
                    // Populate form only AFTER reading JSON file:
                    populateFormFromJSON(config);
                } catch (err) {
                    alert("Invalid JSON file.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

    </script>

    <script>
        // ==================== Populate Form From JSON ====================
        function populateFormFromJSON(config) {
            // --- 1. General Fields ---
            // Populate standard inputs and checkboxes (name matches key)
            for (const key in config) {
                const el = document.querySelector(`[name="${key}"]`);
                if (el) {
                    if (el.type === 'checkbox') {
                        el.checked = !!config[key]; // Ensure boolean value
                    } else {
                        el.value = config[key];
                    }
                }
            }

            // --- 2. Time Series Arrays ---
            // Populate main time series fields
            if (Array.isArray(config.time_series)) {
                populateArrayFields('time-series', 'time-series-container', config.time_series);
            }

            // Populate exit time series fields
            if (Array.isArray(config.exit_time_series)) {
                populateArrayFields('exit-time-series', 'exit-time-series-container', config.exit_time_series);
            }

            // --- 3. Indicators ---
            populateIndicators(config);

            // --- 4. Trade Conditions ---
            // Entry trade conditions
            populateConfigBlocks(
                config.entry_trade_conditions,
                'entry-trade-condition',
                entryConditionTypes,
                addEntryTradeCondition
            );

            // Exit trade conditions
            populateConfigBlocks(
                config.exit_trade_conditions,
                'exit-trade-condition',
                exitConditionTypes,
                addExitTradeCondition
            );

            // --- 5. Strategies ---
            // Buy strategy (wrap single object in array)
            populateConfigBlocks(
                [config.buy_strategy],
                'buy-strategy',
                buyStrategyTypes,
                addBuyStrategy
            );

            // Sell strategy
            populateConfigBlocks(
                [config.sell_strategy],
                'sell-strategy',
                sellStrategyTypes,
                addSellStrategy
            );

            // Exit strategy
            populateConfigBlocks(
                [config.exit_strategy],
                'exit-strategy',
                exitStrategyTypes,
                addExitStrategy
            );

            // --- 6. Identify Entry Blocks ---
            populateIdentifyBlocks(
                config.identify_entry,
                'identify-entry-container',
                identifyEntryClasses,
                'identify_entry',
                config.indicators
            );

            // --- 7. Identify Exit Blocks ---
            populateIdentifyBlocks(
                config.identify_exit,
                'identify-exit-container',
                identifyExitClasses,
                'identify_exit',
                config.indicators
            );
        }

        function populateIndicators(config) {
            const container = document.getElementById('indicators-container');
            container.innerHTML = '';  // Clear previous blocks
            let indicatorCount = 0;

            config.indicators?.forEach(ind => {
                // 1️⃣ Create the block
                const block = createConfigBlock('indicator', indicatorClasses, indicatorCount, 'indicator', true, true);

                // 2️⃣ Set type select
                const select = block.querySelector(`select[name="indicator_type_${indicatorCount}"]`);
                if (select) select.value = ind.type;

                // 3️⃣ Populate args
                const argsDiv = block.querySelector(`#indicator_args_${indicatorCount}`);
                const params = indicatorClasses[ind.type] || [];
                params.forEach((param, i) => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = `indicator_arg_${indicatorCount}_${param}`;
                    input.placeholder = param;
                    input.value = ind.args?.[i] ?? '';  // safe access
                    argsDiv.appendChild(input);
                });

                // 4️⃣ Append block to container
                container.appendChild(block);

                indicatorCount++;
            });

            // 5️⃣ Update hidden count field
            const numField = document.getElementById('num-indicators');
            if (numField) numField.value = indicatorCount;
        }

        function populateIdentifyBlocks(configArray, containerId, blockClasses, prefix, indicators) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // clear previous
            let count = 0;

            configArray?.forEach(item => {
                const index = count;

                // 1️⃣ Create the block
                const block = createConfigBlock(prefix.replace('_', '-'), blockClasses, index, prefix, true);

                // 2️⃣ Add indicator_ref_index dropdown
                const label = document.createElement('label');
                label.textContent = 'Indicator Ref Index: ';

                const refSelect = document.createElement('select');
                refSelect.name = `${prefix}_indicator_ref_${index}`;

                indicators.forEach((ind, idx) => {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = `${ind.type} (index ${idx})`;
                    if (idx === item.indicator_ref_index) {
                        option.selected = true;
                    }
                    refSelect.appendChild(option);
                });

                block.appendChild(document.createElement('br'));
                block.appendChild(label);
                block.appendChild(refSelect);

                // 3️⃣ Append block to container
                container.appendChild(block);

                // 4️⃣ Set type and trigger change to populate args
                const typeSelect = block.querySelector(`select[name="${prefix}_type_${index}"]`);
                if (typeSelect) {
                    typeSelect.value = item.type;
                    typeSelect.dispatchEvent(new Event('change'));
                }

                count++;
            });

            // 5️⃣ Update hidden count field
            const countField = document.getElementById(`num-${prefix.replace('_', '-')}`);
            if (countField) countField.value = count;
        }
        
        function populateConfigBlocks(configArray, prefix, typeMap, addBlockFn) {
            configArray.forEach((item, index) => {
                // Add the block
                addBlockFn();

                // Select the type dropdown
                const typeEl = document.querySelector(`[name="${prefix}_type_${index}"]`);
                if (!typeEl) {
                    console.warn(`No type element found for ${prefix} index ${index}`);
                    return;
                }

                // Set the type
                typeEl.value = item.type;

                // Generate argument input fields
                updateArgsFields(typeMap, prefix, index);

                // Populate argument values
                setArgsFields(item.args || [], prefix, index, typeMap);
            });
        }

        function setArgsFields(args, prefix, index, typeMap) {
            if (!Array.isArray(args)) return;

            // Get selected type to know parameter names
            const select = document.querySelector(`[name="${prefix}_type_${index}"]`);
            if (!select) return;
            const selectedType = select.value;

            // Use provided typeMap or fallback to empty object
            const map = typeMap || {};

            const paramNames = map[selectedType] || [];

            args.forEach((argValue, argIndex) => {
                const paramName = paramNames[argIndex] || `arg${argIndex}`;
                const argEl = document.querySelector(
                    `[name="${prefix}_arg_${index}_${paramName}"]`
                );
                if (argEl) {
                    argEl.value = argValue;
                } else {
                    console.warn(`No input found for ${prefix}_arg_${index}_${paramName}`);
                }
            });
        }
    </script>
</body>
</html>


