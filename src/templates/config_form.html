<!DOCTYPE html>
<html>
<head>
    <title>Config Editor</title>
</head>
<body>
    <h1>Config Editor</h1>
    <form method="POST">
        <h2>Load JSON Config</h2>
        <input type="file" id="json-upload" accept=".json">
        <button type="button" onclick="loadJSONConfig()">Load Config</button>

        <label>Name:</label>
        <input type="text" name="name" value="{{ config['name'] }}"><br>

        <label>Mode:</label>
        <input type="text" name="mode" value="{{ config['mode'] }}"><br>

        <label>Trade:</label>
        <input type="checkbox" name="trade" {% if config['trade'] %}checked{% endif %}><br>

        <label>Start Time:</label>
        <input type="text" name="start_time" value="{{ config['start_time'] }}"><br>

        <label>End Time:</label>
        <input type="text" name="end_time" value="{{ config['end_time'] }}"><br>

        <label>USD Holdings:</label>
        <input type="number" step="0.01" name="USD_holdings" value="{{ config['USD_holdings'] }}"><br>

        <label>Coin Holdings:</label>
        <input type="number" step="0.01" name="coin_holdings" value="{{ config['coin_holdings'] }}"><br>

        <label>Maker Fee:</label>
        <input type="number" step="0.0001" name="maker_fee" value="{{ config['maker_fee'] }}"><br>

        <label>Taker Fee:</label>
        <input type="number" step="0.0001" name="taker_fee" value="{{ config['taker_fee'] }}"><br>

        <label>Main Time Series:</label>
        <input type="text" name="main_time_series" value="{{ config['main_time_series'] }}"><br>

        <label>Time Series:</label>
        {% for ts in config['time_series'] %}
            <input type="text" name="time_series" value="{{ ts }}"><br>
        {% endfor %}

        <label>Exit Time Series:</label>
        {% for ts in config['exit_time_series'] %}
            <input type="text" name="exit_time_series" value="{{ ts }}"><br>
        {% endfor %}

        <label>CSV Input File:</label>
        <input type="text" name="csv_input_file" value="{{ config['csv_input_file'] }}"><br>

        <hr>

        <h2>Indicators</h2>
        <div id="indicators-container">
            {% for ind in config.indicators %}
                <!-- Existing indicators will be rendered via JS or server-side data -->
            {% endfor %}
        </div>
        <button type="button" onclick="addIndicator()">+ Add Indicator</button>
        <input type="hidden" id="num-indicators" name="num_indicators"  value="{{ config.indicators | length }}">

        <hr>

        <h2>Identify Entries</h2>
        <div id="identify-entry-container"></div>
        <button type="button" onclick="addIdentifyEntry()">+ Add Identify Entry</button>
        <input type="hidden" id="num-identify-entries" name="num_identify_entries" value="0">

        <h2>Identify Exits</h2>
        <div id="identify-exit-container"></div>
        <button type="button" onclick="addIdentifyExit()">+ Add Identify Exit</button>
        <input type="hidden" id="num-identify_exits" name="num_identify_exits" value="0">

        <h2>Entry Trade Conditions</h2>
        <div id="entry-trade-conditions-container">
            {% for condition in config.entry_trade_conditions %}
                <!-- Render existing blocks via JS or initially with server data -->
            {% endfor %}
        </div>
        <button type="button" onclick="addEntryTradeCondition()">+ Add Entry Trade Condition</button>
        <input type="hidden" id="num-entry-trade-conditions" name="num_entry_trade_conditions" value="{{ config.entry_trade_conditions | length }}">


        <h2>Exit Trade Conditions</h2>
        <div id="exit-trade-conditions-container">
            {% for condition in config.exit_trade_conditions %}
                <!-- Render existing blocks via JS or initially with server data -->
            {% endfor %}
        </div>
        <button type="button" onclick="addExitTradeCondition()">+ Add Exit Trade Condition</button>
        <input type="hidden" id="num-exit-trade-conditions" name="num_exit_trade_conditions" value="{{ config.exit_trade_conditions | length }}">


        <h2>Buy Strategy</h2>
        <div id="buy-strategy-container"></div>
        <input type="hidden" name="has_buy_strategy" value="1">
        <button type="button" onclick="addBuyStrategy()">+ Select Buy Strategy</button>


        <h2>Sell Strategy</h2>
        <div id="sell-strategy-container"></div>
        <input type="hidden" name="has_sell_strategy" value="1">
        <button type="button" onclick="addSellStrategy()">+ Select Sell Strategy</button>


        <h2>Exit Strategy</h2>
        <div id="exit-strategy-container"></div>
        <input type="hidden" name="has_exit_strategy" value="1">
        <button type="button" onclick="addExitStrategy()">+ Select Exit Strategy</button>


        <br><br>

        <button type="submit">Save Config</button>
    </form>

    <hr>
    <h2>Raw Config (JSON)</h2>
    <pre>{{ config | tojson(indent=4) }}</pre>

    <script>
        function createConfigBlock(configType, typeMap, index, prefix, showRemove = false) {
            const container = document.createElement('div');
            container.className = `${configType}-block`;
            container.dataset.index = index;

            const select = document.createElement('select');
            select.name = `${prefix}_type_${index}`;
            select.className = `${configType}-select`;
            select.dataset.index = index;

            Object.keys(typeMap).forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.text = type;
                select.appendChild(option);
            });

            container.appendChild(document.createTextNode("Type: "));
            container.appendChild(select);

            const argsDiv = document.createElement('div');
            argsDiv.id = `${prefix}_args_${index}`;
            argsDiv.className = `${configType}-args`;
            container.appendChild(argsDiv);

            // Add event listener
            select.addEventListener('change', () => {
                updateArgsFields(typeMap, prefix, index);
            });

            // Add remove button if requested
            if (showRemove) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'Remove';
                removeBtn.className = 'remove-button';
                removeBtn.style.marginLeft = '10px';

                removeBtn.addEventListener('click', () => {
                    container.remove();
                });

                container.appendChild(removeBtn);
            }

            return container;
        }


        function updateArgsFields(typeMap, prefix, index) {
            const select = document.querySelector(`select[name='${prefix}_type_${index}']`);
            const selectedType = select.value;
            const argsDiv = document.getElementById(`${prefix}_args_${index}`);
            argsDiv.innerHTML = '';

            const paramNames = typeMap[selectedType] || [];
            paramNames.forEach(param => {
                const input = document.createElement('input');
                input.type = 'text';
                input.name = `${prefix}_arg_${index}_${param}`;
                input.placeholder = param;
                argsDiv.appendChild(input);
            });
        }

        let indicatorCount = {{ config.indicators | length }};
        const indicatorClasses = {{ indicator_classes | tojson }};

        let entryTradeConditionCount = {{ config.entry_trade_conditions | length }};
        const entryConditionTypes = {{ entry_condition_classes | tojson }};

        let exitTradeConditionCount = {{ config.exit_trade_conditions | length }};
        const exitConditionTypes = {{ exit_condition_classes | tojson }};

        const buyStrategyTypes = {{ buy_strategy_classes | tojson }};
        const sellStrategyTypes = {{ sell_strategy_classes | tojson }};
        const exitStrategyTypes = {{ exit_strategy_classes | tojson }};

        function addIndicator() {
            const container = document.getElementById('indicators-container');
            const block = createConfigBlock('indicator', indicatorClasses, indicatorCount, 'indicator', true, true);
            container.appendChild(block);
            updateArgsFields(indicatorClasses, 'indicator', indicatorCount);
            indicatorCount++;
            document.getElementById('num-indicators').value = indicatorCount;
        }

        function addEntryTradeCondition() {
            const container = document.getElementById('entry-trade-conditions-container');
            const block = createConfigBlock('entry-trade-condition', entryConditionTypes, entryTradeConditionCount, 'entry-trade-condition', true);
            container.appendChild(block);
            updateArgsFields(entryConditionTypes, 'entry-trade-condition', entryTradeConditionCount);
            document.getElementById('num-entry-trade-conditions').value = ++entryTradeConditionCount;
        }

        function addExitTradeCondition() {
            const container = document.getElementById('exit-trade-conditions-container');
            const block = createConfigBlock('exit-trade-condition', exitConditionTypes, exitTradeConditionCount, 'exit-trade-condition', true);
            container.appendChild(block);
            updateArgsFields(exitConditionTypes, 'exit-trade-condition', exitTradeConditionCount);
            document.getElementById('num-exit-trade-conditions').value = ++exitTradeConditionCount;
        }

        // These are always single-object blocks, so index is always 0
        function addBuyStrategy() {
            const container = document.getElementById('buy-strategy-container');
            container.innerHTML = ''; // Ensure only one exists
            const block = createConfigBlock('buy-strategy', buyStrategyTypes, 0, 'buy-strategy', true);
            container.appendChild(block);
            updateArgsFields(buyStrategyTypes, 'buy-strategy', 0);
        }

        function addSellStrategy() {
            const container = document.getElementById('sell-strategy-container');
            container.innerHTML = '';
            const block = createConfigBlock('sell-strategy', sellStrategyTypes, 0, 'sell-strategy', true);
            container.appendChild(block);
            updateArgsFields(sellStrategyTypes, 'sell-strategy', 0);
        }

        function addExitStrategy() {
            const container = document.getElementById('exit-strategy-container');
            container.innerHTML = '';
            const block = createConfigBlock('exit-strategy', exitStrategyTypes, 0, 'exit-strategy', true);
            container.appendChild(block);
            updateArgsFields(exitStrategyTypes, 'exit-strategy', 0);
        }


        const identifyEntryClasses = {{ identify_entry_classes | tojson }};
        const identifyExitClasses = {{ identify_exit_classes | tojson }};

        let identifyEntryCount = 0;
        let identifyExitCount = 0;

        // General function to add identify entry/exit blocks
        function addConfigBlockWithIndicatorRef(typeKey, typeMap, countVar) {
            const container = document.getElementById(`${typeKey}-container`);
            const block = createConfigBlock(typeKey, typeMap, window[countVar], typeKey, true);

            // Create Indicator Ref Index dropdown
            const indicatorSelect = document.createElement('select');
            indicatorSelect.name = `${typeKey}_indicator_ref_${window[countVar]}`;

            const indicatorBlocks = document.querySelectorAll('.indicator-block');
            indicatorBlocks.forEach((block, idx) => {
                const select = block.querySelector('select');
                const type = select ? select.value : `Indicator ${idx}`;
                const option = document.createElement('option');
                option.value = idx;
                option.text = `${type} (index ${idx})`;
                indicatorSelect.appendChild(option);
            });

            const label = document.createElement('label');
            label.textContent = 'Indicator Ref Index: ';
            block.appendChild(document.createElement('br'));
            block.appendChild(label);
            block.appendChild(indicatorSelect);

            container.appendChild(block);

            window[countVar]++;
            document.getElementById(`num-${typeKey}s`).value = window[countVar];
        }

        // Entry-specific wrapper
        function addIdentifyEntry() {
            addConfigBlockWithIndicatorRef('identify-entry', identifyEntryClasses, 'identifyEntryCount');
        }

        // Exit-specific wrapper
        function addIdentifyExit() {
            addConfigBlockWithIndicatorRef('identify-exit', identifyExitClasses, 'identifyExitCount');
        }

    </script>
<!-- 
    <script>
        function loadJSONConfig() {
            const fileInput = document.getElementById('json-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select a JSON file.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const config = JSON.parse(e.target.result);
                    // Populate form only AFTER reading JSON file:
                    populateFormFromJSON(config);
                } catch (err) {
                    alert("Invalid JSON file.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

    </script>
    <script>
    function populateFormFromJSON(config) {
        // === General Fields ===
        for (const key in config) {
            const el = document.querySelector(`[name="${key}"]`);
            if (el) {
                el.value = config[key];
            }
        }

        // === Indicators ===
        document.getElementById('indicators-container').innerHTML = '';
        indicatorCount = 0;
        config.indicators.forEach(ind => {
            const block = createConfigBlock('indicator', indicatorClasses, indicatorCount, 'indicator', true, true);
            const select = block.querySelector(`select[name="indicator_type_${indicatorCount}"]`);
            if (select) select.value = ind.type;

            const argsDiv = block.querySelector(`#indicator_args_${indicatorCount}`);
            const params = indicatorClasses[ind.type] || [];
            params.forEach((param, i) => {
                const input = document.createElement('input');
                input.type = 'text';
                input.name = `indicator_arg_${indicatorCount}_${param}`;
                input.placeholder = param;
                input.value = ind.args[i] || '';
                argsDiv.appendChild(input);
            });

            document.getElementById('indicators-container').appendChild(block);
            indicatorCount++;

            console.log('Block:', block);

        });
        document.getElementById('num-indicators').value = indicatorCount;



        // === Identify Entries ===
        document.getElementById('identify-entry-container').innerHTML = '';
        identifyEntryCount = 0;
        config.identify_entry?.forEach(entry => {
            const index = identifyEntryCount;

            const block = createConfigBlock('identify_entry', identifyEntryClasses, index, 'identify_entry', true);

            // Set type dropdown value
            const select = block.querySelector(`select[name="identify_entry_type_${index}"]`);
            if (select) {
                select.value = entry.type;
                // Trigger change event to populate args fields (if any)
                select.dispatchEvent(new Event('change'));
            }

            // Create and append the indicator_ref_index dropdown
            const label = document.createElement('label');
            label.textContent = 'Indicator Ref Index: ';

            const refSelect = document.createElement('select');
            refSelect.name = `identify_entry_indicator_ref_${index}`;

            config.indicators.forEach((ind, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${ind.type} (index ${idx})`;
                if (idx === entry.indicator_ref_index) {
                    option.selected = true;
                }
                refSelect.appendChild(option);
            });

            // Append the dropdown to the block
            block.appendChild(document.createElement('br'));
            block.appendChild(label);
            block.appendChild(refSelect);

            // Add the full block to the container
            document.getElementById('identify-entry-container').appendChild(block);

            identifyEntryCount++;
        });
        document.getElementById('num-identify-entries').value = identifyEntryCount;



        // === Identify Exits ===
        document.getElementById('identify-exit-container').innerHTML = '';
        identifyExitCount = 0;
        config.identify_exit?.forEach(exit => {
            const index = identifyExitCount;

            const block = createConfigBlock('identify_exit', identifyExitClasses, index, 'identify_exit', true);

            // Set type dropdown value
            const select = block.querySelector(`select[name="identify_exit_type_${index}"]`);
            if (select) {
                select.value = exit.type;
                // Trigger change event to populate args fields (if any)
                select.dispatchEvent(new Event('change'));
            }

            // Create and append the indicator_ref_index dropdown
            const label = document.createElement('label');
            label.textContent = 'Indicator Ref Index: ';

            const refSelect = document.createElement('select');
            refSelect.name = `identify_exit_indicator_ref_${index}`;

            config.indicators.forEach((ind, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${ind.type} (index ${idx})`;
                if (idx === exit.indicator_ref_index) {
                    option.selected = true;
                }
                refSelect.appendChild(option);
            });

            // Append the dropdown to the block
            block.appendChild(document.createElement('br'));
            block.appendChild(label);
            block.appendChild(refSelect);

            // Add the full block to the container
            document.getElementById('identify-exit-container').appendChild(block);

            identifyExitCount++;
        });
        document.getElementById('num-identify-exits').value = identifyExitCount;

    }
    </script> -->


</body>
</html>


