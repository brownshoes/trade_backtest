<!DOCTYPE html>
<html>
<head>
    <title>Config Editor</title>
</head>
<body>
    <h1>Config Editor</h1>
    <form method="POST">
        <label>Name:</label>
        <input type="text" name="name" value="{{ config['name'] }}"><br>

        <label>Mode:</label>
        <input type="text" name="mode" value="{{ config['mode'] }}"><br>

        <label>Trade:</label>
        <input type="checkbox" name="trade" {% if config['trade'] %}checked{% endif %}><br>

        <label>Start Time:</label>
        <input type="text" name="start_time" value="{{ config['start_time'] }}"><br>

        <label>End Time:</label>
        <input type="text" name="end_time" value="{{ config['end_time'] }}"><br>

        <label>USD Holdings:</label>
        <input type="number" step="0.01" name="USD_holdings" value="{{ config['USD_holdings'] }}"><br>

        <label>Coin Holdings:</label>
        <input type="number" step="0.01" name="coin_holdings" value="{{ config['coin_holdings'] }}"><br>

        <label>Maker Fee:</label>
        <input type="number" step="0.0001" name="maker_fee" value="{{ config['maker_fee'] }}"><br>

        <label>Taker Fee:</label>
        <input type="number" step="0.0001" name="taker_fee" value="{{ config['taker_fee'] }}"><br>

        <label>Main Time Series:</label>
        <input type="text" name="main_time_series" value="{{ config['main_time_series'] }}"><br>

        <label>Time Series:</label>
        {% for ts in config['time_series'] %}
            <input type="text" name="time_series" value="{{ ts }}"><br>
        {% endfor %}

        <label>Exit Time Series:</label>
        {% for ts in config['exit_time_series'] %}
            <input type="text" name="exit_time_series" value="{{ ts }}"><br>
        {% endfor %}

        <label>CSV Input File:</label>
        <input type="text" name="csv_input_file" value="{{ config['csv_input_file'] }}"><br>

        <hr>

        <h2>Indicators</h2>
        <div id="indicators-container">
            {% for ind in config.indicators %}
                {% set i = loop.index0 %}
                <div class="indicator-block" data-index="{{ i }}">
                    <label>Type:</label>
                    <select name="indicator_type_{{ i }}" class="indicator-select" data-index="{{ i }}" onchange="updateArgsFields({{ i }})">
                        {% for ind_type in indicator_classes %}
                            <option value="{{ ind_type }}" {% if ind.type == ind_type %}selected{% endif %}>{{ ind_type }}</option>
                        {% endfor %}
                    </select>

                    <div class="indicator-args" id="args_{{ i }}">
                        {% set arg_schema = indicator_classes[ind.type] %}
                        {% for param in arg_schema %}
                            {% set j = loop.index0 %}
                            <input type="text" name="indicator_args_{{ i }}" placeholder="{{ param }}" value="{{ ind.args[j] if j < ind.args | length else '' }}">
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <button type="button" onclick="addIndicator()">+ Add Indicator</button>
        <input type="hidden" name="num_indicators" id="num_indicators" value="{{ config.indicators | length }}">

        <hr>

        <hr>
        <h2>Identify Entry Rules</h2>
        <div id="entry-rules-container">
            {% for rule in config.identify_entry %}
                {% set i = loop.index0 %}
                <div class="entry-rule-block" data-index="{{ i }}">
                    <select name="entry_type_{{ i }}">
                        {% for entry_type in identify_entry_classes %}
                            <option value="{{ entry_type }}" {% if rule.type == entry_type %}selected{% endif %}>{{ entry_type }}</option>
                        {% endfor %}
                    </select>

                    <label>Indicator Index:</label>
                    <input type="number" name="entry_indicator_index_{{ i }}" value="{{ rule.indicator_ref_index }}">
                </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addEntryRule()">+ Add Entry Rule</button>
        <input type="hidden" name="num_entry_rules" id="num_entry_rules" value="{{ config.identify_entry | length }}">

        <h2>Identify Exit Rules</h2>
        <div id="exit-rules-container">
            {% for rule in config.identify_exit %}
                {% set i = loop.index0 %}
                <div class="exit-rule-block" data-index="{{ i }}">
                    <select name="exit_type_{{ i }}">
                        {% for exit_type in identify_exit_classes %}
                            <option value="{{ exit_type }}" {% if rule.type == exit_type %}selected{% endif %}>{{ exit_type }}</option>
                        {% endfor %}
                    </select>

                    <label>Indicator Index:</label>
                    <input type="number" name="exit_indicator_index_{{ i }}" value="{{ rule.indicator_ref_index }}">
                </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addExitRule()">+ Add Exit Rule</button>
        <input type="hidden" name="num_exit_rules" id="num_exit_rules" value="{{ config.identify_exit | length }}">

        <button type="submit">Save Config</button>
    </form>

    <hr>
    <h2>Raw Config (JSON)</h2>
    <pre>{{ config | tojson(indent=4) }}</pre>

    <script>
    const indicatorClasses = {{ indicator_classes | tojson }};
    let indicatorCount = {{ config.indicators | length }};

    function createIndicatorBlock(index, selectedType = null, args = []) {
        const container = document.createElement('div');
        container.className = 'indicator-block';
        container.dataset.index = index;

        // Dropdown
        const select = document.createElement('select');
        select.name = `indicator_type_${index}`;
        select.className = 'indicator-select';
        select.dataset.index = index;
        select.onchange = function() { updateArgsFields(index); };

        for (let type in indicatorClasses) {
            const option = document.createElement('option');
            option.value = type;
            option.text = type;
            if (selectedType === type) option.selected = true;
            select.appendChild(option);
        }

        container.appendChild(document.createTextNode("Type:"));
        container.appendChild(select);

        // Args inputs
        const argsDiv = document.createElement('div');
        argsDiv.id = `args_${index}`;
        argsDiv.className = 'indicator-args';

        const typeToUse = selectedType || select.value;
        const paramNames = indicatorClasses[typeToUse] || [];

        paramNames.forEach((param, i) => {
            const input = document.createElement('input');
            input.type = 'text';
            input.name = `indicator_args_${index}`;
            input.placeholder = param;
            input.value = args[i] || '';
            argsDiv.appendChild(input);
        });

        container.appendChild(argsDiv);

        return container;
    }

    function updateArgsFields(index) {
        const select = document.querySelector(`select[name='indicator_type_${index}']`);
        const selectedType = select.value;
        const argsDiv = document.getElementById(`args_${index}`);
        argsDiv.innerHTML = '';

        const paramNames = indicatorClasses[selectedType];
        paramNames.forEach(param => {
            const input = document.createElement('input');
            input.type = 'text';
            input.name = `indicator_args_${index}`;
            input.placeholder = param;
            argsDiv.appendChild(input);
        });
    }

    function addIndicator() {
        const container = document.getElementById('indicators-container');
        const newBlock = createIndicatorBlock(indicatorCount);
        container.appendChild(newBlock);
        indicatorCount += 1;
        document.getElementById('num_indicators').value = indicatorCount;
    }

    let entryRuleCount = {{ config.identify_entry | length }};
    let exitRuleCount = {{ config.identify_exit | length }};
    const entryTypes = {{ identify_entry_classes | tojson }};
    const exitTypes = {{ identify_exit_classes | tojson }};

    function addEntryRule() {
        const container = document.getElementById('entry-rules-container');
        const div = document.createElement('div');
        div.className = 'entry-rule-block';
        div.dataset.index = entryRuleCount;

        const select = document.createElement('select');
        select.name = `entry_type_${entryRuleCount}`;
        entryTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.text = type;
            select.appendChild(option);
        });

        const input = document.createElement('input');
        input.type = 'number';
        input.name = `entry_indicator_index_${entryRuleCount}`;
        input.placeholder = 'Indicator Index';

        div.appendChild(select);
        div.appendChild(document.createTextNode(' Indicator Index: '));
        div.appendChild(input);
        container.appendChild(div);

        entryRuleCount += 1;
        document.getElementById('num_entry_rules').value = entryRuleCount;
    }

    function addExitRule() {
        const container = document.getElementById('exit-rules-container');
        const div = document.createElement('div');
        div.className = 'exit-rule-block';
        div.dataset.index = exitRuleCount;

        const select = document.createElement('select');
        select.name = `exit_type_${exitRuleCount}`;
        exitTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.text = type;
            select.appendChild(option);
        });

        const input = document.createElement('input');
        input.type = 'number';
        input.name = `exit_indicator_index_${exitRuleCount}`;
        input.placeholder = 'Indicator Index';

        div.appendChild(select);
        div.appendChild(document.createTextNode(' Indicator Index: '));
        div.appendChild(input);
        container.appendChild(div);

        exitRuleCount += 1;
        document.getElementById('num_exit_rules').value = exitRuleCount;
    }

    </script>
</body>
</html>


