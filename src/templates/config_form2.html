<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trading Config Editor</title>
<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #dfe3e8;
  color: #222;
}
h1 {
  margin: 0;
  padding: 20px;
  background: #2b3a4a;
  color: #fff;
  text-align: center;
  font-weight: 500;
  letter-spacing: 0.5px;
}

/* Alternating background bands */
.section-row {
  padding: 25px 30px;
}
.section-row:nth-child(odd) {
  background-color: #f0f3f8;
}
.section-row:nth-child(even) {
  background-color: #e6ebf2;
}

/* Fieldsets */
fieldset {
  border: 1px solid #bbb;
  border-radius: 8px;
  margin-bottom: 20px;
  padding: 15px;
  background: #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
legend {
  font-weight: bold;
  color: #ffffff;
  background: #3b5b8a;
  padding: 6px 14px;
  border-radius: 6px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
/* Inputs and Buttons */
input, select, button {
  padding: 7px;
  font-size: 0.9em;
  border-radius: 5px;
  border: 1px solid #bbb;
}
button {
  cursor: pointer;
  background: #44576d;
  color: #fff;
  border: none;
  transition: 0.2s;
}
button:hover {
  background: #2f3f50;
}
.block {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 5px;
  border-radius: 5px;
  background: #fafafa;
}

/* Layout helpers */
.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.form-group {
  display: flex;
  flex-direction: column;
  min-width: 120px;
}
/* Unique classes for 25% left-aligned fields */
.compact-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: flex-start; /* keep items left-aligned */
  margin-bottom: 10px;
}

.compact-field {
  display: flex;
  flex-direction: column;
  flex: 1 1 25%;   /* base width 25% */
  max-width: 25%;  /* restrict max width */
  min-width: 180px; /* prevents shrinking too much */
}
/* Label styling for compact fields */
.compact-field label {
  font-weight: 600;         /* make label slightly bold */
  font-size: 0.95em;        /* slightly smaller font size */
  color: #333;              /* dark gray text */
  margin-bottom: 5px;       /* space between label and input */
  letter-spacing: 0.2px;    /* subtle letter spacing */
}

/* Optional: focus highlight for input fields */
.compact-field input,
.compact-field select {
  padding: 6px 8px;
  border-radius: 5px;
  border: 1px solid #bbb;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.compact-field input:focus,
.compact-field select:focus {
  border-color: #3b5b8a;
  box-shadow: 0 0 4px rgba(59, 91, 138, 0.3);
  outline: none;
}

/* Styling for top row fields: Config Name, Mode, Trade Enabled */
.top-field label {
  font-weight: 600;        /* slightly bold */
  font-size: 0.95em;       /* slightly smaller font */
  color: #333;             /* dark gray */
  margin-bottom: 5px;      /* spacing below label */
  letter-spacing: 0.2px;   /* subtle letter spacing */
}

/* Inputs and selects */
.top-field input,
.top-field select {
  padding: 6px 8px;
  border-radius: 5px;
  border: 1px solid #bbb;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.top-field input:focus,
.top-field select:focus {
  border-color: #3b5b8a;
  box-shadow: 0 0 4px rgba(59, 91, 138, 0.3);
  outline: none;
}

/* Checkbox alignment */
.top-field input[type="checkbox"] {
  width: auto;
  margin-top: 6px; /* align visually with label */
}



/* Responsive: full width on small screens */
@media (max-width: 900px) {
  .compact-field {
    flex: 1 1 100%;
    max-width: 100%;
  }
}

.dual-section, .conditions-row {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}
.dual-section fieldset, .conditions-row fieldset {
  flex: 1;
  min-width: 300px;
}
.side-by-side {
  display: flex;
  gap: 25px;
  flex-wrap: wrap;
}
.left-col, .right-col {
  flex: 1;
  min-width: 300px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

/* Strategies */
.strategies-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-areas:
    "buy sell"
    "exit .";
  gap: 25px;
}
.strategy-buy { grid-area: buy; }
.strategy-sell { grid-area: sell; }
.strategy-exit { grid-area: exit; }

/* Submit */
#submitBtn {
  padding: 12px 25px;
  font-weight: bold;
  font-size: 1em;
  background: #2b3a4a;
  color: #fff;
  border: none;
  border-radius: 6px;
  transition: 0.2s;
}
#submitBtn:hover {
  background: #1e2833;
}

/* Responsive */
@media (max-width: 900px) {
  .strategies-grid {
    grid-template-columns: 1fr;
    grid-template-areas:
      "buy"
      "sell"
      "exit";
  }
}
</style>
</head>
<body>

<h1>Trading Config Editor</h1>

<!-- === Load JSON === -->
<div class="section-row" style="text-align:center;">
  <label for="jsonFileInput" style="font-weight:bold; margin-right:10px;">Upload JSON File:</label>
  <input type="file" id="jsonFileInput" accept=".json">
</div>

<!-- === General Config === -->
<div class="section-row">
  <fieldset id="generalConfig" class="config-fieldset">
    <legend>General Configuration</legend>

    <div class="form-row row-bg-1">
    <div class="form-group top-field" style="flex: 1 1 30%;">
        <label for="name">Config Name:</label>
        <input type="text" id="name" name="name">
    </div>

    <div class="form-group top-field" style="flex: 1 1 20%;">
        <label for="mode">Mode:</label>
        <select id="mode" name="mode">
        <option value="BACKTEST">BACKTEST</option>
        <option value="LIVE">LIVE</option>
        </select>
    </div>

    <div class="form-group top-field" style="flex: 1 1 20%;">
        <label for="trade">Trade Enabled:</label>
        <input type="checkbox" id="trade" name="trade">
    </div>
    </div>


    <!-- Start and End Time -->
    <div class="compact-row">
    <div class="compact-field">
        <label for="start_time">Start Time:</label>
        <input type="datetime-local" id="start_time" name="start_time">
    </div>

    <div class="compact-field">
        <label for="end_time">End Time:</label>
        <input type="datetime-local" id="end_time" name="end_time">
    </div>
    </div>

    <!-- USD and Coin Holdings -->
    <div class="compact-row">
    <div class="compact-field">
        <label for="USD_holdings">USD Holdings:</label>
        <input type="number" id="USD_holdings" name="USD_holdings">
    </div>

    <div class="compact-field">
        <label for="coin_holdings">Coin Holdings:</label>
        <input type="number" id="coin_holdings" name="coin_holdings">
    </div>
    </div>

    <!-- Maker and Taker Fee -->
    <div class="compact-row">
    <div class="compact-field">
        <label for="maker_fee">Maker Fee:</label>
        <input type="number" step="0.001" id="maker_fee" name="maker_fee">
    </div>

    <div class="compact-field">
        <label for="taker_fee">Taker Fee:</label>
        <input type="number" step="0.001" id="taker_fee" name="taker_fee">
    </div>
    </div>

    <!-- Main Time Series -->
    <div class="compact-row">
    <div class="compact-field">
        <label for="main_time_series">Main Time Series:</label>
        <select id="main_time_series" name="main_time_series">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
        <option value="1h">1h</option>
        <option value="1d">1d</option>
        </select>
    </div>
    </div>

    <div class="compact-row">
      <div class="compact-field" style="flex: 1 1 100%;">
        <label for="csv_input_file">CSV Input File:</label>
        <input type="text" id="csv_input_file" name="csv_input_file" placeholder="path/to/file.csv">
      </div>
    </div>

  </fieldset>
</div>



<!-- === Time Series Row === -->
<div class="section-row dual-section">
  <fieldset>
    <legend>Time Series</legend>
    <button id="addTimeSeriesBtn">Add</button>
    <div id="timeSeriesContainer" class="block"></div>
  </fieldset>

  <fieldset>
    <legend>Exit Time Series</legend>
    <button id="addExitTimeSeriesBtn">Add</button>
    <div id="exitTimeSeriesContainer" class="block"></div>
  </fieldset>
</div>

<!-- === Indicators + Identify === -->
<div class="section-row side-by-side">
  <div class="left-col">
    <fieldset>
      <legend>Indicators</legend>
      <div class="form-row">
        <select id="indicatorSelect">
          <option value="">-- Select --</option>
          {% for key in indicators %}
            <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
        <button id="addIndicatorBtn">Add</button>
      </div>
      <div id="indicatorsContainer" class="block"></div>
    </fieldset>
  </div>

  <div class="right-col">
    <fieldset>
      <legend>Identify Entry</legend>
      <div class="form-row">
        <select id="entrySelect">
          <option value="">-- Select --</option>
          {% for key in identify_entry_classes %}
            <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
        <button id="addEntryBtn">Add</button>
      </div>
      <div id="entryContainer" class="block"></div>
    </fieldset>

    <fieldset>
      <legend>Identify Exit</legend>
      <div class="form-row">
        <select id="exitSelect">
          <option value="">-- Select --</option>
          {% for key in identify_exit_classes %}
            <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
        <button id="addExitBtn">Add</button>
      </div>
      <div id="exitContainer" class="block"></div>
    </fieldset>
  </div>
</div>

<!-- === Entry/Exit Conditions === -->
<div class="section-row conditions-row">
  <fieldset>
    <legend>Entry Trade Conditions</legend>
    <div class="form-row">
      <select id="entryConditionSelect">
        <option value="">-- Select --</option>
        {% for key in entry_trade_conditions_classes %}
          <option value="{{ key }}">{{ key }}</option>
        {% endfor %}
      </select>
      <button id="addEntryConditionBtn">Add</button>
    </div>
    <div id="entryConditionsContainer" class="block"></div>
  </fieldset>

  <fieldset>
    <legend>Exit Trade Conditions</legend>
    <div class="form-row">
      <select id="exitConditionSelect">
        <option value="">-- Select --</option>
        {% for key in exit_trade_conditions_classes %}
          <option value="{{ key }}">{{ key }}</option>
        {% endfor %}
      </select>
      <button id="addExitConditionBtn">Add</button>
    </div>
    <div id="exitConditionsContainer" class="block"></div>
  </fieldset>
</div>

<!-- === Strategies === -->
<div class="section-row">
  <div class="strategies-grid">
    <fieldset class="strategy-buy">
      <legend>Buy Strategy</legend>
      <div class="form-row">
        <select id="buyStrategySelect">
          <option value="">-- Select --</option>
          {% for key in buy_strategies_classes %}
            <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
        <button id="addBuyStrategyBtn">Add</button>
      </div>
      <div id="buyStrategyContainer" class="block"></div>
    </fieldset>

    <fieldset class="strategy-sell">
      <legend>Sell Strategy</legend>
      <div class="form-row">
        <select id="sellStrategySelect">
          <option value="">-- Select --</option>
          {% for key in sell_strategies_classes %}
            <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
        <button id="addSellStrategyBtn">Add</button>
      </div>
      <div id="sellStrategyContainer" class="block"></div>
    </fieldset>

    <fieldset class="strategy-exit">
      <legend>Exit Strategy</legend>
      <div class="form-row">
        <select id="exitStrategySelect">
          <option value="">-- Select --</option>
          {% for key in exit_strategies_classes %}
            <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
        <button id="addExitStrategyBtn">Add</button>
      </div>
      <div id="exitStrategyContainer" class="block"></div>
    </fieldset>
  </div>
</div>

<!-- === Submit === -->
<div class="section-row" style="text-align:center;">
  <button type="button" id="submitBtn">Submit to Flask</button>
</div>

</body>
</html>


<script>
// ==== Globals from Flask ====
const INDICATOR_CLASSES = {{ indicators | tojson }};

// ==== DOM Elements ====
const jsonInput = document.getElementById('jsonFileInput');
const indicatorsContainer = document.getElementById('indicatorsContainer');
const indicatorSelect = document.getElementById('indicatorSelect');

// ==== Indicators State ====
let indicatorsList = [];
let nextRef = 1;

// ==== Helper to Update Entry/Exit Select Options ====
function updateIndicatorOptions(select, selectedRefs = []) {
    select.innerHTML = '';
    indicatorsList.forEach(ind => {
        const option = document.createElement('option');
        option.value = ind.ref;
        option.textContent = `${ind.type} (Ref: ${ind.ref})`;
        if (selectedRefs.includes(String(ind.ref))) option.selected = true;
        select.appendChild(option);
    });
}

function refreshAllEntryExitSelects() {
    document.querySelectorAll('#entryContainer select, #exitContainer select')
        .forEach(select => {
            const selected = Array.from(select.selectedOptions).map(o => o.value);
            updateIndicatorOptions(select, selected);
        });
}

// ==== TIME SERIES ====
document.getElementById('addTimeSeriesBtn').addEventListener('click', () => addTimeSeries());

function addTimeSeries(value = "") {
    const div = document.createElement('div');
    div.className = 'block';

    const input = document.createElement('input');
    input.type = 'text';
    input.value = value;
    input.placeholder = "e.g. 15m, 1h, 4h";
    div.appendChild(input);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(removeBtn);

    document.getElementById('timeSeriesContainer').appendChild(div);
}

// ==== EXIT TIME SERIES ====
document.getElementById('addExitTimeSeriesBtn').addEventListener('click', () => addExitTimeSeries());

function addExitTimeSeries(value = "") {
    const div = document.createElement('div');
    div.className = 'block';

    const input = document.createElement('input');
    input.type = 'text';
    input.value = value;
    input.placeholder = "e.g. 15m, 1h, 4h";
    div.appendChild(input);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(removeBtn);

    document.getElementById('exitTimeSeriesContainer').appendChild(div);
}

// ==== Add Indicator ====
document.getElementById('addIndicatorBtn').addEventListener('click', () => {
  const type = indicatorSelect.value;
  if (!type) return alert("Select an indicator first.");
  addIndicator(type);
});

function addIndicator(type, args = [], ref = null) {
    const argNames = INDICATOR_CLASSES[type] || [];
    ref = ref || nextRef++;
    const div = document.createElement('div');
    div.className = 'block';
    div.dataset.ref = ref;

    const title = document.createElement('h3');
    title.textContent = `${type} (Ref: ${ref})`;
    div.appendChild(title);

    const inputs = [];
    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
        inputs.push(input);
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => {
        div.remove();
        indicatorsList = indicatorsList.filter(ind => ind.ref !== ref);
        refreshAllEntryExitSelects();
    };
    div.appendChild(removeBtn);

    indicatorsContainer.appendChild(div);
    indicatorsList.push({ref, type, args: inputs});
    refreshAllEntryExitSelects();
}

// ==== Add Entry ====
document.getElementById('addEntryBtn').addEventListener('click', () => {
    const type = document.getElementById('entrySelect').value;
    if (!type) return alert("Select an entry type first.");
    addEntry(type);
});

function addEntry(type, selectedRefs = []) {
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    const label = document.createElement('label');
    label.textContent = "Select Indicator Ref(s): ";
    div.appendChild(label);
    div.appendChild(document.createElement('br'));

    const select = document.createElement('select');
    select.multiple = true;
    select.size = 3;
    updateIndicatorOptions(select, selectedRefs);
    div.appendChild(select);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(document.createElement('br'));
    div.appendChild(removeBtn);

    document.getElementById('entryContainer').appendChild(div);
}

// ==== Add Exit ====
document.getElementById('addExitBtn').addEventListener('click', () => {
    const type = document.getElementById('exitSelect').value;
    if (!type) return alert("Select an exit type first.");
    addExit(type);
});

function addExit(type, selectedRefs = []) {
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    const label = document.createElement('label');
    label.textContent = "Select Indicator Ref(s): ";
    div.appendChild(label);
    div.appendChild(document.createElement('br'));

    const select = document.createElement('select');
    select.multiple = true;
    select.size = 3;
    updateIndicatorOptions(select, selectedRefs);
    div.appendChild(select);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(document.createElement('br'));
    div.appendChild(removeBtn);

    document.getElementById('exitContainer').appendChild(div);
}

// ==== Globals for Trade Conditions ====
const ENTRY_TRADE_CONDITIONS = {{ entry_trade_conditions_classes | tojson }};
const EXIT_TRADE_CONDITIONS = {{ exit_trade_conditions_classes | tojson }};

// ==== Entry Trade Conditions ====
document.getElementById('addEntryConditionBtn').addEventListener('click', () => {
    const type = document.getElementById('entryConditionSelect').value;
    if (!type) return alert("Select an entry trade condition first.");
    addEntryCondition(type);
});

function addEntryCondition(type, args = []) {
    const argNames = ENTRY_TRADE_CONDITIONS[type] || [];
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(removeBtn);

    document.getElementById('entryConditionsContainer').appendChild(div);
}

// ==== Exit Trade Conditions ====
document.getElementById('addExitConditionBtn').addEventListener('click', () => {
    const type = document.getElementById('exitConditionSelect').value;
    if (!type) return alert("Select an exit trade condition first.");
    addExitCondition(type);
});

function addExitCondition(type, args = []) {
    const argNames = EXIT_TRADE_CONDITIONS[type] || [];
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(removeBtn);

    document.getElementById('exitConditionsContainer').appendChild(div);
}

// ==== Globals for Strategies ====
const BUY_STRATEGIES_CLASSES = {{ buy_strategies_classes | tojson }};
const SELL_STRATEGIES_CLASSES = {{ sell_strategies_classes | tojson }};
const EXIT_STRATEGIES_CLASSES = {{ exit_strategies_classes | tojson }};

// ==== BUY STRATEGY ====
document.getElementById('addBuyStrategyBtn').addEventListener('click', () => {
    const type = document.getElementById('buyStrategySelect').value;
    if (!type) return alert("Select a buy strategy first.");
    addBuyStrategy(type);
});

function addBuyStrategy(type, args = []) {
    const argNames = BUY_STRATEGIES_CLASSES[type] || [];
    const container = document.getElementById('buyStrategyContainer');
    container.innerHTML = ''; // only one buy strategy

    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => container.innerHTML = '';
    div.appendChild(removeBtn);

    container.appendChild(div);
}

// ==== SELL STRATEGY ====
document.getElementById('addSellStrategyBtn').addEventListener('click', () => {
    const type = document.getElementById('sellStrategySelect').value;
    if (!type) return alert("Select a sell strategy first.");
    addSellStrategy(type);
});

function addSellStrategy(type, args = []) {
    const argNames = SELL_STRATEGIES_CLASSES[type] || [];
    const container = document.getElementById('sellStrategyContainer');
    container.innerHTML = ''; // only one sell strategy

    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => container.innerHTML = '';
    div.appendChild(removeBtn);

    container.appendChild(div);
}

// ==== EXIT STRATEGY ====
document.getElementById('addExitStrategyBtn').addEventListener('click', () => {
    const type = document.getElementById('exitStrategySelect').value;
    if (!type) return alert("Select an exit strategy first.");
    addExitStrategy(type);
});

function addExitStrategy(type, args = []) {
    const argNames = EXIT_STRATEGIES_CLASSES[type] || [];
    const container = document.getElementById('exitStrategyContainer');
    container.innerHTML = ''; // only one exit strategy

    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => container.innerHTML = '';
    div.appendChild(removeBtn);

    container.appendChild(div);
}



// ==== JSON Upload ====
jsonInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = event => {
    try {
      const data = JSON.parse(event.target.result);
      loadFromJSON(data);
    } catch {
      alert("Invalid JSON file.");
    }
  };
  reader.readAsText(file);
});

// ==== Load JSON ====
// ==== Load JSON with error diagnostics ====
function loadFromJSON(data) {
    try {
        try {
            // --- Automatically populate all single-value fields ---
            document.querySelectorAll('input, select, textarea').forEach(el => {
                const key = el.name; // JSON key should match input name
                if (!key || !(key in data)) return; // skip if no match

                const value = data[key];

                try {
                    if (el.type === 'checkbox') {
                        el.checked = !!value;
                    } else if (el.type === 'number') {
                        el.value = parseFloat(value) || 0;
                    } else if (el.type === 'datetime-local') {
                        // Convert from "YYYY-MM-DD HH:MM" to "YYYY-MM-DDTHH:MM"
                        el.value = value.replace(' ', 'T');
                    } else {
                        el.value = value;
                    }
                } catch (err) {
                    console.error(`Failed to populate field "${key}":`, err);
                }
            });
        } catch (e) {
            console.error('Failed to load single-value fields from JSON:', e);
        }

        // Time series
        if (data.time_series) {
            data.time_series.forEach(ts => {
                try {
                    addTimeSeries(ts);
                } catch (e) {
                    console.error(`Failed to add time_series value: ${ts}`, e);
                }
            });
        }

        if (data.exit_time_series) {
            data.exit_time_series.forEach(ts => {
                try {
                    addExitTimeSeries(ts);
                } catch (e) {
                    console.error(`Failed to add exit_time_series value: ${ts}`, e);
                }
            });
        }

        // Reset containers
        indicatorsContainer.innerHTML = '';
        document.getElementById('entryContainer').innerHTML = '';
        document.getElementById('exitContainer').innerHTML = '';
        indicatorsList = [];
        nextRef = 1;

        // Indicators
        (data.indicators || []).forEach(ind => {
            try {
                const ref = ind.ref ?? nextRef++;
                addIndicator(ind.type, ind.args || [], ref);
                if (ref >= nextRef) nextRef = ref + 1;
            } catch (e) {
                console.error('Failed to add indicator:', ind, e);
            }
        });

        // Identify Entry
        (data.identify_entry || []).forEach(entry => {
            try {
                addEntry(entry.type, (entry.indicator_ref || []).map(String));
            } catch (e) {
                console.error('Failed to add identify_entry:', entry, e);
            }
        });

        // Identify Exit
        (data.identify_exit || []).forEach(exit => {
            try {
                addExit(exit.type, (exit.indicator_ref || []).map(String));
            } catch (e) {
                console.error('Failed to add identify_exit:', exit, e);
            }
        });

        // Entry Trade Conditions
        document.getElementById('entryConditionsContainer').innerHTML = '';
        (data.entry_trade_conditions || []).forEach(cond => {
            try {
                addEntryCondition(cond.type, cond.args || []);
            } catch (e) {
                console.error('Failed to add entry_trade_condition:', cond, e);
            }
        });

        // Exit Trade Conditions
        document.getElementById('exitConditionsContainer').innerHTML = '';
        (data.exit_trade_conditions || []).forEach(cond => {
            try {
                addExitCondition(cond.type, cond.args || []);
            } catch (e) {
                console.error('Failed to add exit_trade_condition:', cond, e);
            }
        });

        // Buy, Sell, Exit strategies
        const buyStrategy = data.buy_strategy || { type: null, args: [] };
        const sellStrategy = data.sell_strategy || { type: null, args: [] };
        const exitStrategy = data.exit_strategy || { type: null, args: [] };

        if (buyStrategy.type) {
            try { addBuyStrategy(buyStrategy.type, buyStrategy.args); }
            catch(e) { console.error('Failed to add buy_strategy:', buyStrategy, e); }
        }

        if (sellStrategy.type) {
            try { addSellStrategy(sellStrategy.type, sellStrategy.args); }
            catch(e) { console.error('Failed to add sell_strategy:', sellStrategy, e); }
        }

        if (exitStrategy.type) {
            try { addExitStrategy(exitStrategy.type, exitStrategy.args); }
            catch(e) { console.error('Failed to add exit_strategy:', exitStrategy, e); }
        }

    } catch (globalError) {
        console.error('Failed to load JSON:', data, globalError);
    }
}


// ==== Collect Data ====
function getTimeSeries(containerId) {
    return Array.from(document.querySelectorAll(`#${containerId} input`))
        .map(i => i.value.trim())
        .filter(v => v);
}

function getEntries() {
    return Array.from(document.querySelectorAll('#entryContainer .block')).map(block => ({
        type: block.querySelector('h3').textContent,
        indicator_ref: Array.from(block.querySelector('select').selectedOptions)
            .map(o => Number(o.value)) // Convert to integers
    }));
}

function getExits() {
    return Array.from(document.querySelectorAll('#exitContainer .block')).map(block => ({
        type: block.querySelector('h3').textContent,
        indicator_ref: Array.from(block.querySelector('select').selectedOptions)
            .map(o => Number(o.value)) // Convert to integers
    }));
}

function getStrategy(containerId) {
    const block = document.querySelector(`#${containerId} .block`);
    if (!block) return null;
    const type = block.querySelector('h3').textContent;
    const args = Array.from(block.querySelectorAll('input')).map(i => parseTypedValue(i.value));
    return { type, args };
}

function collectData() {
    const data = {};

    // --- Collect all single-value fields dynamically first ---
    document.querySelectorAll('input, select, textarea').forEach(el => {
        const key = el.name;
        if (!key) return;

        try {
            let value;
            if (el.type === 'checkbox') value = el.checked;
            else if (el.type === 'number') value = parseFloat(el.value) || 0;
            else if (el.type === 'datetime-local') value = el.value.replace('T', ' ');
            else value = el.value;

            data[key] = value;
        } catch (err) {
            console.error(`Failed to collect value from field "${key}":`, err);
        }
    });

    // --- Now add structured arrays and strategy objects ---
    data.time_series = getTimeSeries('timeSeriesContainer');
    data.exit_time_series = getTimeSeries('exitTimeSeriesContainer');
    data.indicators = indicatorsList.map(ind => ({
        ref: ind.ref,
        type: ind.type,
        args: ind.args.map(i => parseTypedValue(i.value))
    }));
    data.identify_entry = getEntries();
    data.identify_exit = getExits();
    data.buy_strategy = getStrategy('buyStrategyContainer');
    data.sell_strategy = getStrategy('sellStrategyContainer');
    data.exit_strategy = getStrategy('exitStrategyContainer');

    return data;
}

function parseTypedValue(value) {
    // If it's already a number, return as-is
    if (typeof value === 'number') return value;

    // Handle null/undefined explicitly
    if (value === null || value === undefined) return value;

    // If empty string, return as-is (don’t convert to 0)
    if (value === '') return value;

    // Try to detect and convert numeric types
    if (/^-?\d+$/.test(value)) return parseInt(value, 10);     // Integer
    if (/^-?\d*\.\d+$/.test(value)) return parseFloat(value);  // Float

    // Everything else stays a string
    return value;
}

// ==== Submit ====
document.getElementById('submitBtn').addEventListener('click', async () => {
  const data = collectData();
  console.log("Sending data:", data);
  try {
    const res = await fetch("/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    alert("✅ Sent to Flask!\n\n" + JSON.stringify(result, null, 2));
  } catch (err) {
    alert("❌ Failed to send data.");
  }
});
</script>
</body>
</html>
