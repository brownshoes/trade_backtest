<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trading Config Editor</title>
<style>
body { font-family: Arial, sans-serif; margin: 40px; }
input, select, textarea, button { padding: 5px; margin: 5px; }
fieldset { margin-bottom: 20px; padding: 10px; }
.block { border: 1px solid #ccc; padding: 10px; margin-top: 10px; border-radius: 5px; }
button { margin-top: 5px; }
select[multiple] { width: 200px; }
</style>
</head>
<body>
<h1>Trading Config Editor</h1>

<!-- JSON Load -->
<label>Upload JSON File:</label>
<input type="file" id="jsonFileInput" accept=".json"><br><br>

<fieldset id="generalConfig" class="config-fieldset">
    <legend>General Configuration</legend>

    <div class="form-group">
        <label for="name">Config Name:</label>
        <input type="text" id="name" name="name" />
    </div>

    <div class="form-group">
        <label for="mode">Mode:</label>
        <select id="mode" name="mode">
            <option value="BACKTEST">BACKTEST</option>
            <option value="LIVE">LIVE</option>
        </select>
    </div>

    <div class="form-group">
        <label for="trade">Trade Enabled:</label>
        <input type="checkbox" id="trade" name="trade" />
    </div>

    <div class="form-group">
        <label for="start_time">Start Time:</label>
        <input type="datetime-local" id="start_time" name="start_time" />
    </div>

    <div class="form-group">
        <label for="end_time">End Time:</label>
        <input type="datetime-local" id="end_time" name="end_time" />
    </div>

    <div class="form-group">
        <label for="USD_holdings">USD Holdings:</label>
        <input type="number" id="USD_holdings" name="USD_holdings" />
    </div>

    <div class="form-group">
        <label for="coin_holdings">Coin Holdings:</label>
        <input type="number" id="coin_holdings" name="coin_holdings" />
    </div>

    <div class="form-group">
        <label for="maker_fee">Maker Fee:</label>
        <input type="number" step="0.001" id="maker_fee" name="maker_fee" />
    </div>

    <div class="form-group">
        <label for="taker_fee">Taker Fee:</label>
        <input type="number" step="0.001" id="taker_fee" name="taker_fee" />
    </div>

    <div class="form-group">
        <label for="main_time_series">Main Time Series:</label>
        <select id="main_time_series" name="main_time_series">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="1h">1h</option>
            <option value="1d">1d</option>
        </select>
    </div>
</fieldset>

<!-- TIME SERIES SECTION -->
<fieldset>
  <legend>Time Series</legend>
  <button type="button" id="addTimeSeriesBtn">Add Time Series</button>
  <div id="timeSeriesContainer"></div>
</fieldset>

<!-- EXIT TIME SERIES SECTION -->
<fieldset>
  <legend>Exit Time Series</legend>
  <button type="button" id="addExitTimeSeriesBtn">Add Exit Time Series</button>
  <div id="exitTimeSeriesContainer"></div>
</fieldset>

<!-- Indicators Section -->
<fieldset>
<legend>Indicators</legend>
<label for="indicatorSelect">Select Indicator:</label>
<select id="indicatorSelect">
  <option value="">-- Select --</option>
  {% for key in indicators %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>
<button type="button" id="addIndicatorBtn">Add Indicator</button>
<div id="indicatorsContainer"></div>
</fieldset>

<!-- Identify Entry Section -->
<fieldset>
<legend>Identify Entry</legend>
<label for="entrySelect">Select Entry Type:</label>
<select id="entrySelect">
  <option value="">-- Select --</option>
  {% for key in identify_entry_classes %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>
<button type="button" id="addEntryBtn">Add Entry</button>
<div id="entryContainer"></div>
</fieldset>

<!-- Identify Exit Section -->
<fieldset>
<legend>Identify Exit</legend>
<label for="exitSelect">Select Exit Type:</label>
<select id="exitSelect">
  <option value="">-- Select --</option>
  {% for key in identify_exit_classes %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>
<button type="button" id="addExitBtn">Add Exit</button>
<div id="exitContainer"></div>
</fieldset>

<!-- Entry Trade Conditions Section -->
<fieldset>
<legend>Entry Trade Conditions</legend>
<label for="entryConditionSelect">Select Entry Trade Condition:</label>
<select id="entryConditionSelect">
  <option value="">-- Select --</option>
  {% for key in entry_trade_conditions_classes %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>
<button type="button" id="addEntryConditionBtn">Add Condition</button>
<div id="entryConditionsContainer"></div>
</fieldset>

<!-- Exit Trade Conditions Section -->
<fieldset>
<legend>Exit Trade Conditions</legend>
<label for="exitConditionSelect">Select Exit Trade Condition:</label>
<select id="exitConditionSelect">
  <option value="">-- Select --</option>
  {% for key in exit_trade_conditions_classes %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>
<button type="button" id="addExitConditionBtn">Add Condition</button>
<div id="exitConditionsContainer"></div>
</fieldset>

<!-- BUY STRATEGY SECTION -->
<fieldset>
  <legend>Buy Strategy</legend>
  <label for="buyStrategySelect">Select Buy Strategy:</label>
  <select id="buyStrategySelect">
    <option value="">-- Select --</option>
    {% for key in buy_strategies_classes %}
      <option value="{{ key }}">{{ key }}</option>
    {% endfor %}
  </select>
  <button type="button" id="addBuyStrategyBtn">Add Buy Strategy</button>
  <div id="buyStrategyContainer"></div>
</fieldset>

<!-- SELL STRATEGY SECTION -->
<fieldset>
  <legend>Sell Strategy</legend>
  <label for="sellStrategySelect">Select Sell Strategy:</label>
  <select id="sellStrategySelect">
    <option value="">-- Select --</option>
    {% for key in sell_strategies_classes %}
      <option value="{{ key }}">{{ key }}</option>
    {% endfor %}
  </select>
  <button type="button" id="addSellStrategyBtn">Add Sell Strategy</button>
  <div id="sellStrategyContainer"></div>
</fieldset>

<!-- EXIT STRATEGY SECTION -->
<fieldset>
  <legend>Exit Strategy</legend>
  <label for="exitStrategySelect">Select Exit Strategy:</label>
  <select id="exitStrategySelect">
    <option value="">-- Select --</option>
    {% for key in exit_strategies_classes %}
      <option value="{{ key }}">{{ key }}</option>
    {% endfor %}
  </select>
  <button type="button" id="addExitStrategyBtn">Add Exit Strategy</button>
  <div id="exitStrategyContainer"></div>
</fieldset>


<!-- Submit Button -->
<button type="button" id="submitBtn">Submit to Flask</button>

<script>
// ==== Globals from Flask ====
const INDICATOR_CLASSES = {{ indicators | tojson }};

// ==== DOM Elements ====
const jsonInput = document.getElementById('jsonFileInput');
const indicatorsContainer = document.getElementById('indicatorsContainer');
const indicatorSelect = document.getElementById('indicatorSelect');

// ==== Indicators State ====
let indicatorsList = [];
let nextRef = 1;

// ==== Helper to Update Entry/Exit Select Options ====
function updateIndicatorOptions(select, selectedRefs = []) {
    select.innerHTML = '';
    indicatorsList.forEach(ind => {
        const option = document.createElement('option');
        option.value = ind.ref;
        option.textContent = `${ind.type} (Ref: ${ind.ref})`;
        if (selectedRefs.includes(String(ind.ref))) option.selected = true;
        select.appendChild(option);
    });
}

function refreshAllEntryExitSelects() {
    document.querySelectorAll('#entryContainer select, #exitContainer select')
        .forEach(select => {
            const selected = Array.from(select.selectedOptions).map(o => o.value);
            updateIndicatorOptions(select, selected);
        });
}

// ==== TIME SERIES ====
document.getElementById('addTimeSeriesBtn').addEventListener('click', () => addTimeSeries());

function addTimeSeries(value = "") {
    const div = document.createElement('div');
    div.className = 'block';

    const input = document.createElement('input');
    input.type = 'text';
    input.value = value;
    input.placeholder = "e.g. 15m, 1h, 4h";
    div.appendChild(input);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(removeBtn);

    document.getElementById('timeSeriesContainer').appendChild(div);
}

// ==== EXIT TIME SERIES ====
document.getElementById('addExitTimeSeriesBtn').addEventListener('click', () => addExitTimeSeries());

function addExitTimeSeries(value = "") {
    const div = document.createElement('div');
    div.className = 'block';

    const input = document.createElement('input');
    input.type = 'text';
    input.value = value;
    input.placeholder = "e.g. 15m, 1h, 4h";
    div.appendChild(input);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(removeBtn);

    document.getElementById('exitTimeSeriesContainer').appendChild(div);
}

// ==== Add Indicator ====
document.getElementById('addIndicatorBtn').addEventListener('click', () => {
  const type = indicatorSelect.value;
  if (!type) return alert("Select an indicator first.");
  addIndicator(type);
});

function addIndicator(type, args = [], ref = null) {
    const argNames = INDICATOR_CLASSES[type] || [];
    ref = ref || nextRef++;
    const div = document.createElement('div');
    div.className = 'block';
    div.dataset.ref = ref;

    const title = document.createElement('h3');
    title.textContent = `${type} (Ref: ${ref})`;
    div.appendChild(title);

    const inputs = [];
    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
        inputs.push(input);
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => {
        div.remove();
        indicatorsList = indicatorsList.filter(ind => ind.ref !== ref);
        refreshAllEntryExitSelects();
    };
    div.appendChild(removeBtn);

    indicatorsContainer.appendChild(div);
    indicatorsList.push({ref, type, args: inputs});
    refreshAllEntryExitSelects();
}

// ==== Add Entry ====
document.getElementById('addEntryBtn').addEventListener('click', () => {
    const type = document.getElementById('entrySelect').value;
    if (!type) return alert("Select an entry type first.");
    addEntry(type);
});

function addEntry(type, selectedRefs = []) {
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    const label = document.createElement('label');
    label.textContent = "Select Indicator Ref(s): ";
    div.appendChild(label);
    div.appendChild(document.createElement('br'));

    const select = document.createElement('select');
    select.multiple = true;
    select.size = 3;
    updateIndicatorOptions(select, selectedRefs);
    div.appendChild(select);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(document.createElement('br'));
    div.appendChild(removeBtn);

    document.getElementById('entryContainer').appendChild(div);
}

// ==== Add Exit ====
document.getElementById('addExitBtn').addEventListener('click', () => {
    const type = document.getElementById('exitSelect').value;
    if (!type) return alert("Select an exit type first.");
    addExit(type);
});

function addExit(type, selectedRefs = []) {
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    const label = document.createElement('label');
    label.textContent = "Select Indicator Ref(s): ";
    div.appendChild(label);
    div.appendChild(document.createElement('br'));

    const select = document.createElement('select');
    select.multiple = true;
    select.size = 3;
    updateIndicatorOptions(select, selectedRefs);
    div.appendChild(select);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(document.createElement('br'));
    div.appendChild(removeBtn);

    document.getElementById('exitContainer').appendChild(div);
}

// ==== Globals for Trade Conditions ====
const ENTRY_TRADE_CONDITIONS = {{ entry_trade_conditions_classes | tojson }};
const EXIT_TRADE_CONDITIONS = {{ exit_trade_conditions_classes | tojson }};

// ==== Entry Trade Conditions ====
document.getElementById('addEntryConditionBtn').addEventListener('click', () => {
    const type = document.getElementById('entryConditionSelect').value;
    if (!type) return alert("Select an entry trade condition first.");
    addEntryCondition(type);
});

function addEntryCondition(type, args = []) {
    const argNames = ENTRY_TRADE_CONDITIONS[type] || [];
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(removeBtn);

    document.getElementById('entryConditionsContainer').appendChild(div);
}

// ==== Exit Trade Conditions ====
document.getElementById('addExitConditionBtn').addEventListener('click', () => {
    const type = document.getElementById('exitConditionSelect').value;
    if (!type) return alert("Select an exit trade condition first.");
    addExitCondition(type);
});

function addExitCondition(type, args = []) {
    const argNames = EXIT_TRADE_CONDITIONS[type] || [];
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(removeBtn);

    document.getElementById('exitConditionsContainer').appendChild(div);
}

// ==== Globals for Strategies ====
const BUY_STRATEGIES_CLASSES = {{ buy_strategies_classes | tojson }};
const SELL_STRATEGIES_CLASSES = {{ sell_strategies_classes | tojson }};
const EXIT_STRATEGIES_CLASSES = {{ exit_strategies_classes | tojson }};

// ==== BUY STRATEGY ====
document.getElementById('addBuyStrategyBtn').addEventListener('click', () => {
    const type = document.getElementById('buyStrategySelect').value;
    if (!type) return alert("Select a buy strategy first.");
    addBuyStrategy(type);
});

function addBuyStrategy(type, args = []) {
    const argNames = BUY_STRATEGIES_CLASSES[type] || [];
    const container = document.getElementById('buyStrategyContainer');
    container.innerHTML = ''; // only one buy strategy

    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => container.innerHTML = '';
    div.appendChild(removeBtn);

    container.appendChild(div);
}

// ==== SELL STRATEGY ====
document.getElementById('addSellStrategyBtn').addEventListener('click', () => {
    const type = document.getElementById('sellStrategySelect').value;
    if (!type) return alert("Select a sell strategy first.");
    addSellStrategy(type);
});

function addSellStrategy(type, args = []) {
    const argNames = SELL_STRATEGIES_CLASSES[type] || [];
    const container = document.getElementById('sellStrategyContainer');
    container.innerHTML = ''; // only one sell strategy

    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => container.innerHTML = '';
    div.appendChild(removeBtn);

    container.appendChild(div);
}

// ==== EXIT STRATEGY ====
document.getElementById('addExitStrategyBtn').addEventListener('click', () => {
    const type = document.getElementById('exitStrategySelect').value;
    if (!type) return alert("Select an exit strategy first.");
    addExitStrategy(type);
});

function addExitStrategy(type, args = []) {
    const argNames = EXIT_STRATEGIES_CLASSES[type] || [];
    const container = document.getElementById('exitStrategyContainer');
    container.innerHTML = ''; // only one exit strategy

    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => container.innerHTML = '';
    div.appendChild(removeBtn);

    container.appendChild(div);
}



// ==== JSON Upload ====
jsonInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = event => {
    try {
      const data = JSON.parse(event.target.result);
      loadFromJSON(data);
    } catch {
      alert("Invalid JSON file.");
    }
  };
  reader.readAsText(file);
});

// ==== Load JSON ====
// ==== Load JSON with error diagnostics ====
function loadFromJSON(data) {
    try {
        try {
            // --- Automatically populate all single-value fields ---
            document.querySelectorAll('input, select, textarea').forEach(el => {
                const key = el.name; // JSON key should match input name
                if (!key || !(key in data)) return; // skip if no match

                const value = data[key];

                try {
                    if (el.type === 'checkbox') {
                        el.checked = !!value;
                    } else if (el.type === 'number') {
                        el.value = parseFloat(value) || 0;
                    } else if (el.type === 'datetime-local') {
                        // Convert from "YYYY-MM-DD HH:MM" to "YYYY-MM-DDTHH:MM"
                        el.value = value.replace(' ', 'T');
                    } else {
                        el.value = value;
                    }
                } catch (err) {
                    console.error(`Failed to populate field "${key}":`, err);
                }
            });
        } catch (e) {
            console.error('Failed to load single-value fields from JSON:', e);
        }

        // Time series
        if (data.time_series) {
            data.time_series.forEach(ts => {
                try {
                    addTimeSeries(ts);
                } catch (e) {
                    console.error(`Failed to add time_series value: ${ts}`, e);
                }
            });
        }

        if (data.exit_time_series) {
            data.exit_time_series.forEach(ts => {
                try {
                    addExitTimeSeries(ts);
                } catch (e) {
                    console.error(`Failed to add exit_time_series value: ${ts}`, e);
                }
            });
        }

        // Reset containers
        indicatorsContainer.innerHTML = '';
        document.getElementById('entryContainer').innerHTML = '';
        document.getElementById('exitContainer').innerHTML = '';
        indicatorsList = [];
        nextRef = 1;

        // Indicators
        (data.indicators || []).forEach(ind => {
            try {
                const ref = ind.ref ?? nextRef++;
                addIndicator(ind.type, ind.args || [], ref);
                if (ref >= nextRef) nextRef = ref + 1;
            } catch (e) {
                console.error('Failed to add indicator:', ind, e);
            }
        });

        // Identify Entry
        (data.identify_entry || []).forEach(entry => {
            try {
                addEntry(entry.type, (entry.indicator_ref || []).map(String));
            } catch (e) {
                console.error('Failed to add identify_entry:', entry, e);
            }
        });

        // Identify Exit
        (data.identify_exit || []).forEach(exit => {
            try {
                addExit(exit.type, (exit.indicator_ref || []).map(String));
            } catch (e) {
                console.error('Failed to add identify_exit:', exit, e);
            }
        });

        // Entry Trade Conditions
        document.getElementById('entryConditionsContainer').innerHTML = '';
        (data.entry_trade_conditions || []).forEach(cond => {
            try {
                addEntryCondition(cond.type, cond.args || []);
            } catch (e) {
                console.error('Failed to add entry_trade_condition:', cond, e);
            }
        });

        // Exit Trade Conditions
        document.getElementById('exitConditionsContainer').innerHTML = '';
        (data.exit_trade_conditions || []).forEach(cond => {
            try {
                addExitCondition(cond.type, cond.args || []);
            } catch (e) {
                console.error('Failed to add exit_trade_condition:', cond, e);
            }
        });

        // Buy, Sell, Exit strategies
        const buyStrategy = data.buy_strategy || { type: null, args: [] };
        const sellStrategy = data.sell_strategy || { type: null, args: [] };
        const exitStrategy = data.exit_strategy || { type: null, args: [] };

        if (buyStrategy.type) {
            try { addBuyStrategy(buyStrategy.type, buyStrategy.args); }
            catch(e) { console.error('Failed to add buy_strategy:', buyStrategy, e); }
        }

        if (sellStrategy.type) {
            try { addSellStrategy(sellStrategy.type, sellStrategy.args); }
            catch(e) { console.error('Failed to add sell_strategy:', sellStrategy, e); }
        }

        if (exitStrategy.type) {
            try { addExitStrategy(exitStrategy.type, exitStrategy.args); }
            catch(e) { console.error('Failed to add exit_strategy:', exitStrategy, e); }
        }

    } catch (globalError) {
        console.error('Failed to load JSON:', data, globalError);
    }
}


// ==== Collect Data ====
function getTimeSeries(containerId) {
    return Array.from(document.querySelectorAll(`#${containerId} input`))
        .map(i => i.value.trim())
        .filter(v => v);
}

function getEntries() {
    return Array.from(document.querySelectorAll('#entryContainer .block')).map(block => ({
        type: block.querySelector('h3').textContent,
        indicator_ref: Array.from(block.querySelector('select').selectedOptions).map(o => o.value)
    }));
}

function getExits() {
    return Array.from(document.querySelectorAll('#exitContainer .block')).map(block => ({
        type: block.querySelector('h3').textContent,
        indicator_ref: Array.from(block.querySelector('select').selectedOptions).map(o => o.value)
    }));
}

function getStrategy(containerId) {
    const block = document.querySelector(`#${containerId} .block`);
    if (!block) return null;
    const type = block.querySelector('h3').textContent;
    const args = Array.from(block.querySelectorAll('input')).map(i => i.value);
    return { type, args };
}

function collectData() {
    const data = {};

    // --- Collect all single-value fields dynamically first ---
    document.querySelectorAll('input, select, textarea').forEach(el => {
        const key = el.name;
        if (!key) return;

        try {
            let value;
            if (el.type === 'checkbox') value = el.checked;
            else if (el.type === 'number') value = parseFloat(el.value) || 0;
            else if (el.type === 'datetime-local') value = el.value.replace('T', ' ');
            else value = el.value;

            data[key] = value;
        } catch (err) {
            console.error(`Failed to collect value from field "${key}":`, err);
        }
    });

    // --- Now add structured arrays and strategy objects ---
    data.time_series = getTimeSeries('timeSeriesContainer');
    data.exit_time_series = getTimeSeries('exitTimeSeriesContainer');
    data.indicators = indicatorsList.map(ind => ({
        ref: ind.ref,
        type: ind.type,
        args: ind.args.map(i => i.value)
    }));
    data.identify_entry = getEntries();
    data.identify_exit = getExits();
    data.buy_strategy = getStrategy('buyStrategyContainer');
    data.sell_strategy = getStrategy('sellStrategyContainer');
    data.exit_strategy = getStrategy('exitStrategyContainer');

    return data;
}

// ==== Submit ====
document.getElementById('submitBtn').addEventListener('click', async () => {
  const data = collectData();
  console.log("Sending data:", data);
  try {
    const res = await fetch("/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    alert("✅ Sent to Flask!\n\n" + JSON.stringify(result, null, 2));
  } catch (err) {
    alert("❌ Failed to send data.");
  }
});
</script>
</body>
</html>
