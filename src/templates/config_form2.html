<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trading Config Editor</title>
<style>
body { font-family: Arial, sans-serif; margin: 40px; }
input, select, textarea, button { padding: 5px; margin: 5px; }
fieldset { margin-bottom: 20px; padding: 10px; }
.block { border: 1px solid #ccc; padding: 10px; margin-top: 10px; border-radius: 5px; }
button { margin-top: 5px; }
select[multiple] { width: 200px; }
</style>
</head>
<body>
<h1>Trading Config Editor</h1>

<!-- JSON Load -->
<label>Upload JSON File:</label>
<input type="file" id="jsonFileInput" accept=".json"><br><br>

<!-- Indicators Section -->
<fieldset>
<legend>Indicators</legend>
<label for="indicatorSelect">Select Indicator:</label>
<select id="indicatorSelect">
  <option value="">-- Select --</option>
  {% for key in indicators %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>
<button type="button" id="addIndicatorBtn">Add Indicator</button>
<div id="indicatorsContainer"></div>
</fieldset>

<!-- Identify Entry Section -->
<fieldset>
<legend>Identify Entry</legend>
<label for="entrySelect">Select Entry Type:</label>
<select id="entrySelect">
  <option value="">-- Select --</option>
  {% for key in identify_entry_classes %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>
<button type="button" id="addEntryBtn">Add Entry</button>
<div id="entryContainer"></div>
</fieldset>

<!-- Identify Exit Section -->
<fieldset>
<legend>Identify Exit</legend>
<label for="exitSelect">Select Exit Type:</label>
<select id="exitSelect">
  <option value="">-- Select --</option>
  {% for key in identify_exit_classes %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>
<button type="button" id="addExitBtn">Add Exit</button>
<div id="exitContainer"></div>
</fieldset>

<!-- Entry Trade Conditions Section -->
<fieldset>
<legend>Entry Trade Conditions</legend>
<label for="entryConditionSelect">Select Entry Trade Condition:</label>
<select id="entryConditionSelect">
  <option value="">-- Select --</option>
  {% for key in entry_trade_conditions_classes %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>
<button type="button" id="addEntryConditionBtn">Add Condition</button>
<div id="entryConditionsContainer"></div>
</fieldset>

<!-- Exit Trade Conditions Section -->
<fieldset>
<legend>Exit Trade Conditions</legend>
<label for="exitConditionSelect">Select Exit Trade Condition:</label>
<select id="exitConditionSelect">
  <option value="">-- Select --</option>
  {% for key in exit_trade_conditions_classes %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>
<button type="button" id="addExitConditionBtn">Add Condition</button>
<div id="exitConditionsContainer"></div>
</fieldset>


<!-- Submit Button -->
<button type="button" id="submitBtn">Submit to Flask</button>

<script>
// ==== Globals from Flask ====
const INDICATOR_CLASSES = {{ indicators | tojson }};

// ==== DOM Elements ====
const jsonInput = document.getElementById('jsonFileInput');
const indicatorsContainer = document.getElementById('indicatorsContainer');
const indicatorSelect = document.getElementById('indicatorSelect');

// ==== Indicators State ====
let indicatorsList = [];
let nextRef = 1;

// ==== Helper to Update Entry/Exit Select Options ====
function updateIndicatorOptions(select, selectedRefs = []) {
    select.innerHTML = '';
    indicatorsList.forEach(ind => {
        const option = document.createElement('option');
        option.value = ind.ref;
        option.textContent = `${ind.type} (Ref: ${ind.ref})`;
        if (selectedRefs.includes(String(ind.ref))) option.selected = true;
        select.appendChild(option);
    });
}

function refreshAllEntryExitSelects() {
    document.querySelectorAll('#entryContainer select, #exitContainer select')
        .forEach(select => {
            const selected = Array.from(select.selectedOptions).map(o => o.value);
            updateIndicatorOptions(select, selected);
        });
}

// ==== Add Indicator ====
document.getElementById('addIndicatorBtn').addEventListener('click', () => {
  const type = indicatorSelect.value;
  if (!type) return alert("Select an indicator first.");
  addIndicator(type);
});

function addIndicator(type, args = [], ref = null) {
    const argNames = INDICATOR_CLASSES[type] || [];
    ref = ref || nextRef++;
    const div = document.createElement('div');
    div.className = 'block';
    div.dataset.ref = ref;

    const title = document.createElement('h3');
    title.textContent = `${type} (Ref: ${ref})`;
    div.appendChild(title);

    const inputs = [];
    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
        inputs.push(input);
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => {
        div.remove();
        indicatorsList = indicatorsList.filter(ind => ind.ref !== ref);
        refreshAllEntryExitSelects();
    };
    div.appendChild(removeBtn);

    indicatorsContainer.appendChild(div);
    indicatorsList.push({ref, type, args: inputs});
    refreshAllEntryExitSelects();
}

// ==== Add Entry ====
document.getElementById('addEntryBtn').addEventListener('click', () => {
    const type = document.getElementById('entrySelect').value;
    if (!type) return alert("Select an entry type first.");
    addEntry(type);
});

function addEntry(type, selectedRefs = []) {
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    const label = document.createElement('label');
    label.textContent = "Select Indicator Ref(s): ";
    div.appendChild(label);
    div.appendChild(document.createElement('br'));

    const select = document.createElement('select');
    select.multiple = true;
    select.size = 3;
    updateIndicatorOptions(select, selectedRefs);
    div.appendChild(select);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(document.createElement('br'));
    div.appendChild(removeBtn);

    document.getElementById('entryContainer').appendChild(div);
}

// ==== Add Exit ====
document.getElementById('addExitBtn').addEventListener('click', () => {
    const type = document.getElementById('exitSelect').value;
    if (!type) return alert("Select an exit type first.");
    addExit(type);
});

function addExit(type, selectedRefs = []) {
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    const label = document.createElement('label');
    label.textContent = "Select Indicator Ref(s): ";
    div.appendChild(label);
    div.appendChild(document.createElement('br'));

    const select = document.createElement('select');
    select.multiple = true;
    select.size = 3;
    updateIndicatorOptions(select, selectedRefs);
    div.appendChild(select);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(document.createElement('br'));
    div.appendChild(removeBtn);

    document.getElementById('exitContainer').appendChild(div);
}

// ==== Globals for Trade Conditions ====
const ENTRY_TRADE_CONDITIONS = {{ entry_trade_conditions_classes | tojson }};
const EXIT_TRADE_CONDITIONS = {{ exit_trade_conditions_classes | tojson }};

// ==== Entry Trade Conditions ====
document.getElementById('addEntryConditionBtn').addEventListener('click', () => {
    const type = document.getElementById('entryConditionSelect').value;
    if (!type) return alert("Select an entry trade condition first.");
    addEntryCondition(type);
});

function addEntryCondition(type, args = []) {
    const argNames = ENTRY_TRADE_CONDITIONS[type] || [];
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(removeBtn);

    document.getElementById('entryConditionsContainer').appendChild(div);
}

// ==== Exit Trade Conditions ====
document.getElementById('addExitConditionBtn').addEventListener('click', () => {
    const type = document.getElementById('exitConditionSelect').value;
    if (!type) return alert("Select an exit trade condition first.");
    addExitCondition(type);
});

function addExitCondition(type, args = []) {
    const argNames = EXIT_TRADE_CONDITIONS[type] || [];
    const div = document.createElement('div');
    div.className = 'block';

    const title = document.createElement('h3');
    title.textContent = type;
    div.appendChild(title);

    argNames.forEach((argName, i) => {
        const label = document.createElement('label');
        label.textContent = argName + ": ";
        const input = document.createElement('input');
        input.type = 'text';
        input.value = args[i] || '';
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement('br'));
    });

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.type = 'button';
    removeBtn.onclick = () => div.remove();
    div.appendChild(removeBtn);

    document.getElementById('exitConditionsContainer').appendChild(div);
}

// ==== JSON Upload ====
jsonInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = event => {
    try {
      const data = JSON.parse(event.target.result);
      loadFromJSON(data);
    } catch {
      alert("Invalid JSON file.");
    }
  };
  reader.readAsText(file);
});

// ==== Load JSON ====
function loadFromJSON(data) {
    indicatorsContainer.innerHTML = '';
    document.getElementById('entryContainer').innerHTML = '';
    document.getElementById('exitContainer').innerHTML = '';
    indicatorsList = [];
    nextRef = 1;

    if (data.indicators) {
        data.indicators.forEach(ind => {
            const ref = ind.ref !== undefined ? ind.ref : nextRef++;
            addIndicator(ind.type, ind.args || [], ref);
            if (ref >= nextRef) nextRef = ref + 1;
        });
    }

    if (data.identify_entry) {
        data.identify_entry.forEach(entry => addEntry(entry.type, (entry.indicator_ref || []).map(String)));
    }

    if (data.identify_exit) {
        data.identify_exit.forEach(exit => addExit(exit.type, (exit.indicator_ref || []).map(String)));
    }

    // Entry Trade Conditions
    document.getElementById('entryConditionsContainer').innerHTML = '';
    if (data.entry_trade_conditions) {
        data.entry_trade_conditions.forEach(cond => addEntryCondition(cond.type, cond.args || []));
    }

    // Exit Trade Conditions
    document.getElementById('exitConditionsContainer').innerHTML = '';
    if (data.exit_trade_conditions) {
        data.exit_trade_conditions.forEach(cond => addExitCondition(cond.type, cond.args || []));
    }

}

// ==== Collect Data ====
function getEntries() {
    return Array.from(document.querySelectorAll('#entryContainer .block')).map(block => ({
        type: block.querySelector('h3').textContent,
        indicator_ref: Array.from(block.querySelector('select').selectedOptions).map(o => o.value)
    }));
}

function getExits() {
    return Array.from(document.querySelectorAll('#exitContainer .block')).map(block => ({
        type: block.querySelector('h3').textContent,
        indicator_ref: Array.from(block.querySelector('select').selectedOptions).map(o => o.value)
    }));
}

function collectData() {
    return {
        indicators: indicatorsList.map(ind => ({
            ref: ind.ref,
            type: ind.type,
            args: ind.args.map(i => i.value)
        })),
        identify_entry: getEntries(),
        identify_exit: getExits(),
        entry_trade_conditions: Array.from(document.querySelectorAll('#entryConditionsContainer .block')).map(block => ({
            type: block.querySelector('h3').textContent,
            args: Array.from(block.querySelectorAll('input')).map(i => i.value)
        })),
        exit_trade_conditions: Array.from(document.querySelectorAll('#exitConditionsContainer .block')).map(block => ({
            type: block.querySelector('h3').textContent,
            args: Array.from(block.querySelectorAll('input')).map(i => i.value)
        }))
    };
}

// ==== Submit ====
document.getElementById('submitBtn').addEventListener('click', async () => {
  const data = collectData();
  console.log("Sending data:", data);
  try {
    const res = await fetch("/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    alert("✅ Sent to Flask!\n\n" + JSON.stringify(result, null, 2));
  } catch (err) {
    alert("❌ Failed to send data.");
  }
});
</script>
</body>
</html>
